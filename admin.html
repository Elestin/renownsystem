<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <title>World Configuration Admin</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'IM Fell English SC', serif;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #4a9eff;
            text-shadow: 2px 2px 5px #000;
            margin-bottom: 10px;
        }
        .nav-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-buttons button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit;
        }
        .nav-buttons button:hover {
            background: #6bb0ff;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #4a9eff;
        }
        .tab {
            padding: 10px 20px;
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid #4a9eff;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            color: #b0c4de;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background: rgba(74, 158, 255, 0.2);
            color: #e0e0e0;
        }
        .tab.active {
            background: rgba(74, 158, 255, 0.3);
            color: #4a9eff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a9eff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .section h2 {
            color: #4a9eff;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #4a9eff;
            padding-bottom: 8px;
        }
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        .collapsible::before {
            content: '‚ñº ';
            display: inline-block;
            transition: transform 0.3s ease;
            margin-right: 5px;
        }
        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            font-size: 0.9em;
            margin-bottom: 3px;
        }
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .compact-grid .form-group {
            margin-bottom: 8px;
        }
        .compact-grid label {
            font-size: 0.85em;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #b0c4de;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-family: inherit;
        }
        select option {
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 5px;
        }
        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit;
            margin: 5px;
        }
        button:hover {
            background: #6bb0ff;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .faction-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #4a9eff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .faction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .faction-header h3 {
            margin: 0;
            color: #4a9eff;
            font-size: 1.1em;
        }
        .faction-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .faction-content.collapsed {
            max-height: 0;
            overflow: hidden;
            padding: 0;
        }
        .faction-summary {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #b0c4de;
            margin-top: 5px;
        }
        .faction-summary span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .bonus-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        .bonus-entry input[type="number"] {
            width: 80px;
            padding: 4px;
            font-size: 0.9em;
        }
        .bonus-entry textarea {
            flex: 1;
            padding: 4px;
            font-size: 0.9em;
            min-height: 30px;
        }
        .relationship-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .relationship-entry select {
            flex: 1;
        }
        .color-preview {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #4a9eff;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .message.success {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid #28a745;
        }
        .message.error {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid #dc3545;
        }
        .descriptor-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        .descriptor-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid #4a9eff;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .descriptor-tag .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .descriptor-tag .remove-btn:hover {
            background: #c82333;
        }
        .descriptor-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .descriptor-selector select {
            flex: 1;
            padding: 8px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-family: inherit;
            font-size: 1em;
        }
        .descriptor-selector select option {
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 5px;
        }
        .descriptor-selector select:focus {
            outline: none;
            border-color: #6bb0ff;
            background: rgba(255, 255, 255, 0.15);
        }
        .selected-descriptors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .suggestions-panel {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .suggestion-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .suggestion-item h4 {
            margin: 0 0 5px 0;
            color: #28a745;
        }
        .suggestion-item p {
            margin: 5px 0;
            color: #e0e0e0;
        }
        .suggestion-item button {
            background: #28a745;
            margin-top: 5px;
        }
        .suggestion-item button:hover {
            background: #218838;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background: #1a1a2e;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #4a9eff;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>World Configuration Admin</h1>
        <div class="nav-buttons">
            <button onclick="window.location.href='index.html'">View Main Tracker</button>
        </div>

        <div id="message"></div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'world')">World & Theme</div>
            <div class="tab" onclick="switchTab(event, 'factions')">Factions & Cities</div>
            <div class="tab" onclick="switchTab(event, 'relationships')">Relationships</div>
            <div class="tab" onclick="switchTab(event, 'regional')">Regional Power</div>
        </div>

        <div id="tab-world" class="tab-content active">
            <div class="section">
                <h2 class="collapsible" onclick="toggleCollapse(this)">World Settings</h2>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label>World Name:</label>
                        <input type="text" id="worldName" placeholder="Enter world name">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="collapsible" onclick="toggleCollapse(this)">Theme & Styling</h2>
                <div class="collapsible-content">
                    <div class="compact-grid">
                <div class="form-group">
                    <label>Font Family:</label>
                    <select id="fontFamily">
                        <option value="'IM Fell English SC', serif">IM Fell English SC</option>
                        <option value="'Cinzel', serif">Cinzel</option>
                        <option value="'MedievalSharp', cursive">MedievalSharp</option>
                        <option value="'Uncial Antiqua', cursive">Uncial Antiqua</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Background Color (Top):</label>
                    <input type="color" id="bgColor1" value="#2e1a14">
                    <span class="color-preview" id="bgPreview1"></span>
                </div>
                <div class="form-group">
                    <label>Background Color (Bottom):</label>
                    <input type="color" id="bgColor2" value="#4a3326">
                    <span class="color-preview" id="bgPreview2"></span>
                </div>
                <div class="form-group">
                    <label>Text Color:</label>
                    <input type="color" id="textColor" value="#f8e8c0">
                    <span class="color-preview" id="textPreview"></span>
                </div>
                <div class="form-group">
                    <label>Heading Color:</label>
                    <input type="color" id="headingColor" value="#ffdd8b">
                    <span class="color-preview" id="headingPreview"></span>
                </div>
                <div class="form-group">
                    <label>Table Background:</label>
                    <input type="color" id="tableBg" value="#fff8e4">
                    <span class="color-preview" id="tableBgPreview"></span>
                </div>
                <div class="form-group">
                    <label>Table Border Color:</label>
                    <input type="color" id="tableBorder" value="#523c23">
                    <span class="color-preview" id="tableBorderPreview"></span>
                </div>
                <div class="form-group">
                    <label>Positive Renown Color (Start):</label>
                    <input type="color" id="positiveColor1" value="#2e8b57">
                    <span class="color-preview" id="positivePreview1"></span>
                </div>
                <div class="form-group">
                    <label>Positive Renown Color (End):</label>
                    <input type="color" id="positiveColor2" value="#66cdaa">
                    <span class="color-preview" id="positivePreview2"></span>
                </div>
                <div class="form-group">
                    <label>Neutral Renown Color (Start):</label>
                    <input type="color" id="neutralColor1" value="#4682b4">
                    <span class="color-preview" id="neutralPreview1"></span>
                </div>
                <div class="form-group">
                    <label>Neutral Renown Color (End):</label>
                    <input type="color" id="neutralColor2" value="#87cefa">
                    <span class="color-preview" id="neutralPreview2"></span>
                </div>
                <div class="form-group">
                    <label>Negative Renown Color (Start):</label>
                    <input type="color" id="negativeColor1" value="#b22222">
                    <span class="color-preview" id="negativePreview1"></span>
                </div>
                <div class="form-group">
                    <label>Negative Renown Color (End):</label>
                    <input type="color" id="negativeColor2" value="#dc143c">
                    <span class="color-preview" id="negativePreview2"></span>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-factions" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Factions & Cities</h2>
                    <button onclick="addFaction()">+ Add Faction/City</button>
                </div>
                <div id="factionsList"></div>
            </div>
        </div>

        <div id="tab-relationships" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Relationships</h2>
                    <button onclick="showRelationshipGraph()">üìä View Relationship Graph</button>
                </div>
                <div id="relationshipsList"></div>
            </div>
        </div>

        <div id="tab-regional" class="tab-content">
            <div class="section">
                <h2>Regional Power Dynamics</h2>
                <p style="opacity: 0.8; line-height: 1.6; margin-bottom: 20px;">
                    Manage regional authority, faction power distribution, and inter-faction relationships.
                    Power in each region is balanced: <strong>Faction Power + Authority = 100%</strong>
                </p>

                <!-- Region Management -->
                <div class="section" style="background: rgba(255, 255, 255, 0.02);">
                    <h2 class="collapsible" onclick="toggleCollapse(this)">Region Management</h2>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label>Region Name:</label>
                            <input type="text" id="newRegionName" placeholder="Enter region name (e.g., Waterdeep)">
                        </div>
                        <div class="form-group">
                            <label>Authority/Lawfulness (0-100%):</label>
                            <input type="number" id="newRegionAuthority" min="0" max="100" value="20" placeholder="0-100">
                            <small style="display: block; opacity: 0.7; margin-top: 5px;">
                                Higher authority = stronger law enforcement, less faction power
                            </small>
                        </div>
                        <button class="success" onclick="addRegion()">‚ûï Add Region</button>
                    </div>
                </div>

                <!-- Faction Assignment -->
                <div class="section" style="background: rgba(255, 255, 255, 0.02);">
                    <h2 class="collapsible" onclick="toggleCollapse(this)">Assign Faction to Region</h2>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label>Select Faction:</label>
                            <select id="factionSelectForRegion">
                                <option value="">Select Faction...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Region:</label>
                            <select id="regionSelectForFaction">
                                <option value="">Select Region...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Leader (optional):</label>
                            <input type="text" id="factionLeader" placeholder="Leader name">
                        </div>
                        <div class="form-group">
                            <label>Description (optional):</label>
                            <input type="text" id="factionDescription" placeholder="What the faction does in this region">
                        </div>
                        <div class="form-group">
                            <label>Goals (optional):</label>
                            <input type="text" id="factionGoals" placeholder="What the faction wants to achieve">
                        </div>
                        <button class="success" onclick="assignFactionToRegion()">üìç Assign Faction</button>
                    </div>
                </div>

                <!-- Faction Interactions -->
                <div class="section" style="background: rgba(255, 255, 255, 0.02);">
                    <h2 class="collapsible" onclick="toggleCollapse(this)">Set Faction Interactions</h2>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label>Faction A:</label>
                            <select id="factionASelect">
                                <option value="">Select Faction A...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Interaction Type:</label>
                            <select id="interactionTypeSelect">
                                <option value="war">War (-10 power effect)</option>
                                <option value="alliance">Alliance (+5 power effect)</option>
                                <option value="trade">Trade Agreement (+3 power effect)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Faction B:</label>
                            <select id="factionBSelect">
                                <option value="">Select Faction B...</option>
                            </select>
                        </div>
                        <button class="success" onclick="setFactionInteraction()">ü§ù Set Interaction</button>
                    </div>
                </div>

                <!-- Power Simulation Controls -->
                <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="rollDiceRegional()">üé≤ Roll Dice (Simulate Power Changes)</button>
                    <button onclick="exportRegionalData()">üíæ Export Regional Data</button>
                    <button onclick="importRegionalData()">üìÇ Import Regional Data</button>
                    <input type="file" id="importRegionalFile" style="display: none;" accept=".json" onchange="handleRegionalImport(event)">
                </div>

                <!-- Regions Display -->
                <div id="regionsContainer"></div>

                <!-- Event Log -->
                <div class="section" style="background: rgba(255, 255, 255, 0.02); margin-top: 20px;">
                    <h2 class="collapsible" onclick="toggleCollapse(this)">Event Log</h2>
                    <div class="collapsible-content">
                        <button onclick="clearEventLog()" style="float: right;">üóëÔ∏è Clear Log</button>
                        <div id="eventLog" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; margin-top: 10px;">
                            <p style="opacity: 0.6; font-style: italic; text-align: center;">No events yet. Roll the dice to simulate power changes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="success" onclick="saveWorld()">Save World Configuration</button>
            <button onclick="exportWorld()">Export World to JSON</button>
            <button onclick="importWorld()">Import World from JSON</button>
            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleWorldImport(event)">
            <button class="danger" onclick="loadDefaultWorld()">Load Default World</button>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestionsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSuggestionsModal()">&times;</span>
            <h2 id="modalTitle">Bonus Suggestions</h2>
            <div id="suggestionsContent"></div>
        </div>
    </div>

    <!-- Relationship Graph Modal -->
    <div id="graphModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90vh;">
            <span class="close-modal" onclick="closeGraphModal()">&times;</span>
            <h2>Relationship Graph</h2>
            <div style="margin-bottom: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 5px;">
                <strong>Legend:</strong>
                <span style="color: #4a9eff; margin-left: 20px;">üîµ Faction</span>
                <span style="color: #ffdd8b; margin-left: 20px;">üü° City</span>
                <span style="color: #28a745; margin-left: 20px;">‚îÅ‚îÅ‚îÅ Friends</span>
                <span style="color: #dc3545; margin-left: 20px;">‚îÅ‚îÅ‚îÅ Enemies</span>
            </div>
            <div id="relationshipGraph" style="width: 100%; height: calc(90vh - 150px); border: 1px solid #4a9eff; border-radius: 5px; background: rgba(255, 255, 255, 0.02);"></div>
        </div>
    </div>

    <script>
        let worldData = {
            worldName: "Default World",
            theme: {
                fontFamily: "'IM Fell English SC', serif",
                bgColor1: "#2e1a14",
                bgColor2: "#4a3326",
                textColor: "#f8e8c0",
                headingColor: "#ffdd8b",
                tableBg: "rgba(255, 248, 228, 0.9)",
                tableBorder: "#523c23",
                positiveColor1: "#2e8b57",
                positiveColor2: "#66cdaa",
                neutralColor1: "#4682b4",
                neutralColor2: "#87cefa",
                negativeColor1: "#b22222",
                negativeColor2: "#dc143c"
            },
            factions: [],
            relationships: {}
        };

        // Load world data from localStorage or use default
        function loadWorldData() {
            const saved = localStorage.getItem("worldData");
            if (saved) {
                try {
                    worldData = JSON.parse(saved);
                } catch (e) {
                    console.error("Error loading world data:", e);
                }
            } else {
                loadDefaultWorld();
            }
            renderAll();
        }

        function loadDefaultWorld() {
            worldData = {
                worldName: "Default World",
                theme: {
                    fontFamily: "'IM Fell English SC', serif",
                    bgColor1: "#2e1a14",
                    bgColor2: "#4a3326",
                    textColor: "#f8e8c0",
                    headingColor: "#ffdd8b",
                    tableBg: "rgba(255, 248, 228, 0.9)",
                    tableBorder: "#523c23",
                    positiveColor1: "#2e8b57",
                    positiveColor2: "#66cdaa",
                    neutralColor1: "#4682b4",
                    neutralColor2: "#87cefa",
                    negativeColor1: "#b22222",
                    negativeColor2: "#dc143c"
                },
                factions: [
                    { name: "Example Faction A", bonuses: {
                        "-100": "Faction A declares you an enemy and attacks on sight.",
                        "-80": "Faction A actively hunts the party.",
                        "-60": "Faction A denies services and access.",
                        "-40": "Faction A is hostile and uncooperative.",
                        "-20": "Faction A is suspicious and wary.",
                        "0": "Neutral stance; standard behavior.",
                        "20": "Faction A provides minor assistance.",
                        "40": "Faction A offers discounts and basic services.",
                        "60": "Faction A provides significant support.",
                        "80": "Faction A grants access to exclusive resources.",
                        "100": "Faction A fully supports the party."
                    }},
                    { name: "Example Faction B", bonuses: {
                        "-100": "Faction B marks you for elimination.",
                        "-80": "Faction B actively works against you.",
                        "-60": "Faction B blocks your access to resources.",
                        "-40": "Faction B is unfriendly and obstructive.",
                        "-20": "Faction B is cautious around you.",
                        "0": "Neutral stance; no special treatment.",
                        "20": "Faction B offers basic cooperation.",
                        "40": "Faction B provides helpful services.",
                        "60": "Faction B shares valuable information.",
                        "80": "Faction B grants special privileges.",
                        "100": "Faction B becomes a strong ally."
                    }},
                    { name: "Example City", bonuses: {
                        "-100": "City bars entry to the party.",
                        "-80": "City residents are hostile.",
                        "-60": "City services are denied.",
                        "-40": "City merchants overcharge significantly.",
                        "-20": "City residents are distrustful.",
                        "0": "Neutral stance; standard city services.",
                        "20": "City provides minor discounts.",
                        "40": "City offers helpful guides and services.",
                        "60": "City grants access to exclusive areas.",
                        "80": "City provides free lodging and supplies.",
                        "100": "City honors the party as heroes."
                    }}
                ],
                relationships: {
                    "Example Faction A": {
                        friends: ["Example City"],
                        enemies: ["Example Faction B"]
                    },
                    "Example Faction B": {
                        friends: [],
                        enemies: ["Example Faction A"]
                    },
                    "Example City": {
                        friends: ["Example Faction A"],
                        enemies: ["Example Faction B"]
                    }
                }
            };
            // Save to localStorage so it persists
            localStorage.setItem("worldData", JSON.stringify(worldData));
            renderAll();
            showMessage("Default world loaded", "success");
        }

        function renderAll() {
            document.getElementById("worldName").value = worldData.worldName || "";
            document.getElementById("fontFamily").value = worldData.theme.fontFamily;
            document.getElementById("bgColor1").value = worldData.theme.bgColor1;
            document.getElementById("bgColor2").value = worldData.theme.bgColor2;
            document.getElementById("textColor").value = worldData.theme.textColor;
            document.getElementById("headingColor").value = worldData.theme.headingColor;
            // Extract RGB from rgba format for color picker
            let tableBgValue = "#fff8e4";
            if (worldData.theme.tableBg) {
                const rgbaMatch = worldData.theme.tableBg.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (rgbaMatch) {
                    const r = parseInt(rgbaMatch[1]).toString(16).padStart(2, '0');
                    const g = parseInt(rgbaMatch[2]).toString(16).padStart(2, '0');
                    const b = parseInt(rgbaMatch[3]).toString(16).padStart(2, '0');
                    tableBgValue = `#${r}${g}${b}`;
                } else if (worldData.theme.tableBg.startsWith('#')) {
                    tableBgValue = worldData.theme.tableBg;
                }
            }
            document.getElementById("tableBg").value = tableBgValue;
            document.getElementById("tableBorder").value = worldData.theme.tableBorder;
            document.getElementById("positiveColor1").value = worldData.theme.positiveColor1;
            document.getElementById("positiveColor2").value = worldData.theme.positiveColor2;
            document.getElementById("neutralColor1").value = worldData.theme.neutralColor1;
            document.getElementById("neutralColor2").value = worldData.theme.neutralColor2;
            document.getElementById("negativeColor1").value = worldData.theme.negativeColor1;
            document.getElementById("negativeColor2").value = worldData.theme.negativeColor2;
            
            updateColorPreviews();
            renderFactions();
            renderRelationships();
            renderRegions();
        }

        function updateColorPreviews() {
            document.getElementById("bgPreview1").style.backgroundColor = document.getElementById("bgColor1").value;
            document.getElementById("bgPreview2").style.backgroundColor = document.getElementById("bgColor2").value;
            document.getElementById("textPreview").style.backgroundColor = document.getElementById("textColor").value;
            document.getElementById("headingPreview").style.backgroundColor = document.getElementById("headingColor").value;
            document.getElementById("tableBgPreview").style.backgroundColor = document.getElementById("tableBg").value;
            document.getElementById("tableBorderPreview").style.backgroundColor = document.getElementById("tableBorder").value;
            document.getElementById("positivePreview1").style.backgroundColor = document.getElementById("positiveColor1").value;
            document.getElementById("positivePreview2").style.backgroundColor = document.getElementById("positiveColor2").value;
            document.getElementById("neutralPreview1").style.backgroundColor = document.getElementById("neutralColor1").value;
            document.getElementById("neutralPreview2").style.backgroundColor = document.getElementById("neutralColor2").value;
            document.getElementById("negativePreview1").style.backgroundColor = document.getElementById("negativeColor1").value;
            document.getElementById("negativePreview2").style.backgroundColor = document.getElementById("negativeColor2").value;
        }

        // Add event listeners for color previews
        ['bgColor1', 'bgColor2', 'textColor', 'headingColor', 'tableBg', 'tableBorder', 
         'positiveColor1', 'positiveColor2', 'neutralColor1', 'neutralColor2', 
         'negativeColor1', 'negativeColor2'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateColorPreviews);
        });

        function renderFactions() {
            const container = document.getElementById("factionsList");
            container.innerHTML = "";
            
            worldData.factions.forEach((faction, index) => {
                const div = document.createElement("div");
                div.className = "faction-item";
                const bonusCount = Object.keys(faction.bonuses || {}).length;
                const descriptorCount = (faction.descriptors || []).length;
                const descriptorsList = (faction.descriptors || []).join(', ') || 'None';
                
                div.innerHTML = `
                    <div class="faction-header" onclick="toggleFaction(${index})">
                        <div>
                            <h3>${faction.name}</h3>
                            <div class="faction-summary">
                                <span>üìã ${bonusCount} bonuses</span>
                                <span>üè∑Ô∏è ${descriptorCount} descriptors</span>
                                <span style="font-size: 0.85em; color: #888;">${descriptorsList}</span>
                            </div>
                        </div>
                        <button class="danger" onclick="event.stopPropagation(); removeFaction(${index})">Remove</button>
                    </div>
                    <div class="faction-content collapsed" id="faction-content-${index}">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" value="${faction.name}" onchange="updateFactionName(${index}, this.value)">
                        </div>
                        <div class="form-group">
                            <label>Faction/City Type & Descriptors:</label>
                            <div class="descriptor-selector">
                                <select id="descriptor-select-${index}" onchange="addDescriptor(${index}, this.value)">
                                    <option value="">-- Select a descriptor to add --</option>
                                </select>
                                <button onclick="generateSuggestions(${index})">‚ú® Generate Suggestions</button>
                            </div>
                            <div class="selected-descriptors" id="selected-descriptors-${index}"></div>
                        </div>
                        <div class="form-group">
                            <label>Bonuses/Penalties:</label>
                            <div id="bonuses-${index}"></div>
                            <button onclick="addBonus(${index})">+ Add Bonus/Penalty</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
                
                // Render descriptors
                renderDescriptors(index, faction);
                
                // Render bonuses
                const bonusesContainer = document.getElementById(`bonuses-${index}`);
                Object.keys(faction.bonuses).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
                    const bonusDiv = document.createElement("div");
                    bonusDiv.className = "bonus-entry";
                    bonusDiv.innerHTML = `
                        <input type="number" value="${level}" placeholder="Renown Level" onchange="updateBonusLevel(${index}, '${level}', this.value)">
                        <textarea placeholder="Description" onchange="updateBonusText(${index}, '${level}', this.value)">${faction.bonuses[level]}</textarea>
                        <button class="danger" onclick="removeBonus(${index}, '${level}')">Remove</button>
                    `;
                    bonusesContainer.appendChild(bonusDiv);
                });
            });
        }

        const availableDescriptors = [
            "Pirate", "Naval", "Merchant", "Religious", "Criminal", "Military", 
            "Magical", "Noble", "Cult", "City", "Trading", "Warrior", "Scholar",
            "Assassin", "Thief", "Mercenary", "Explorer", "Diplomat", "Artisan",
            "Mystical", "Ancient", "Corrupt", "Lawful", "Chaotic", "Neutral"
        ];

        function renderDescriptors(index, faction) {
            if (!faction.descriptors) {
                faction.descriptors = [];
            }
            
            // Populate dropdown with available descriptors (excluding already selected ones)
            const select = document.getElementById(`descriptor-select-${index}`);
            select.innerHTML = '<option value="">-- Select a descriptor to add --</option>';
            availableDescriptors.forEach(desc => {
                if (!faction.descriptors.includes(desc)) {
                    const option = document.createElement("option");
                    option.value = desc;
                    option.textContent = desc;
                    select.appendChild(option);
                }
            });
            
            // Render selected descriptors with remove buttons
            const container = document.getElementById(`selected-descriptors-${index}`);
            container.innerHTML = "";
            faction.descriptors.forEach(desc => {
                const tag = document.createElement("div");
                tag.className = "descriptor-tag";
                tag.innerHTML = `
                    <span>${desc}</span>
                    <button class="remove-btn" onclick="removeDescriptor(${index}, '${desc}')" title="Remove ${desc}">√ó</button>
                `;
                container.appendChild(tag);
            });
        }

        function addDescriptor(index, descriptor) {
            if (!descriptor || descriptor === "") return;
            
            if (!worldData.factions[index].descriptors) {
                worldData.factions[index].descriptors = [];
            }
            
            if (!worldData.factions[index].descriptors.includes(descriptor)) {
                worldData.factions[index].descriptors.push(descriptor);
                renderDescriptors(index, worldData.factions[index]);
            }
            
            // Reset dropdown
            document.getElementById(`descriptor-select-${index}`).value = "";
        }

        function removeDescriptor(index, descriptor) {
            if (!worldData.factions[index].descriptors) {
                worldData.factions[index].descriptors = [];
            }
            
            worldData.factions[index].descriptors = worldData.factions[index].descriptors.filter(d => d !== descriptor);
            renderDescriptors(index, worldData.factions[index]);
        }

        function addFaction() {
            worldData.factions.push({
                name: "New Faction",
                bonuses: { "0": "Neutral stance." },
                descriptors: []
            });
            if (!worldData.relationships["New Faction"]) {
                worldData.relationships["New Faction"] = { friends: [], enemies: [] };
            }
            renderFactions();
            renderRelationships();
        }

        function removeFaction(index) {
            const faction = worldData.factions[index];
            delete worldData.relationships[faction.name];
            worldData.factions.splice(index, 1);
            renderFactions();
            renderRelationships();
        }

        function updateFactionName(index, newName) {
            const oldName = worldData.factions[index].name;
            worldData.factions[index].name = newName;
            if (worldData.relationships[oldName]) {
                worldData.relationships[newName] = worldData.relationships[oldName];
                delete worldData.relationships[oldName];
            } else {
                worldData.relationships[newName] = { friends: [], enemies: [] };
            }
            renderFactions();
            renderRelationships();
        }

        function addBonus(factionIndex) {
            const level = prompt("Enter renown level (e.g., -100, 0, 100):");
            if (level !== null && level !== "") {
                worldData.factions[factionIndex].bonuses[level] = "";
                renderFactions();
            }
        }

        function updateBonusLevel(factionIndex, oldLevel, newLevel) {
            const faction = worldData.factions[factionIndex];
            if (oldLevel !== newLevel && newLevel !== "") {
                faction.bonuses[newLevel] = faction.bonuses[oldLevel] || "";
                delete faction.bonuses[oldLevel];
                renderFactions();
            }
        }

        function updateBonusText(factionIndex, level, text) {
            worldData.factions[factionIndex].bonuses[level] = text;
        }

        function removeBonus(factionIndex, level) {
            delete worldData.factions[factionIndex].bonuses[level];
            renderFactions();
        }

        function renderRelationships() {
            const container = document.getElementById("relationshipsList");
            container.innerHTML = "";
            
            worldData.factions.forEach((faction, index) => {
                if (!worldData.relationships[faction.name]) {
                    worldData.relationships[faction.name] = { friends: [], enemies: [] };
                }
                
                const friends = worldData.relationships[faction.name].friends || [];
                const enemies = worldData.relationships[faction.name].enemies || [];
                const friendsList = friends.length > 0 ? friends.join(', ') : 'None';
                const enemiesList = enemies.length > 0 ? enemies.join(', ') : 'None';
                
                const div = document.createElement("div");
                div.className = "faction-item";
                div.innerHTML = `
                    <div class="faction-header" onclick="toggleRelationship('${faction.name}')">
                        <div>
                            <h3>${faction.name}</h3>
                            <div class="faction-summary">
                                <span>ü§ù ${friends.length} friends</span>
                                <span>‚öîÔ∏è ${enemies.length} enemies</span>
                                <span style="font-size: 0.85em; color: #888;">Friends: ${friendsList}</span>
                                <span style="font-size: 0.85em; color: #888;">Enemies: ${enemiesList}</span>
                            </div>
                        </div>
                    </div>
                    <div class="faction-content collapsed" id="relationship-content-${faction.name}">
                        <div class="form-group">
                            <label>Friends:</label>
                            <div id="friends-${faction.name}"></div>
                            <button onclick="addRelationship('${faction.name}', 'friends')">+ Add Friend</button>
                        </div>
                        <div class="form-group">
                            <label>Enemies:</label>
                            <div id="enemies-${faction.name}"></div>
                            <button onclick="addRelationship('${faction.name}', 'enemies')">+ Add Enemy</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
                
                // Render friends
                const friendsContainer = document.getElementById(`friends-${faction.name}`);
                friends.forEach((friend, idx) => {
                    const relDiv = document.createElement("div");
                    relDiv.className = "relationship-entry";
                    relDiv.innerHTML = `
                        <select onchange="updateRelationship('${faction.name}', 'friends', ${idx}, this.value)">
                            ${worldData.factions.map(f => `<option value="${f.name}" ${f.name === friend ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                        <button class="danger" onclick="removeRelationship('${faction.name}', 'friends', ${idx})">Remove</button>
                    `;
                    friendsContainer.appendChild(relDiv);
                });
                
                // Render enemies
                const enemiesContainer = document.getElementById(`enemies-${faction.name}`);
                enemies.forEach((enemy, idx) => {
                    const relDiv = document.createElement("div");
                    relDiv.className = "relationship-entry";
                    relDiv.innerHTML = `
                        <select onchange="updateRelationship('${faction.name}', 'enemies', ${idx}, this.value)">
                            ${worldData.factions.map(f => `<option value="${f.name}" ${f.name === enemy ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                        <button class="danger" onclick="removeRelationship('${faction.name}', 'enemies', ${idx})">Remove</button>
                    `;
                    enemiesContainer.appendChild(relDiv);
                });
            });
        }

        function addRelationship(factionName, type) {
            if (!worldData.relationships[factionName][type]) {
                worldData.relationships[factionName][type] = [];
            }
            const availableFactions = worldData.factions.filter(f => f.name !== factionName).map(f => f.name);
            if (availableFactions.length === 0) {
                alert("No other factions available to add as relationship.");
                return;
            }
            worldData.relationships[factionName][type].push(availableFactions[0]);
            renderRelationships();
        }

        function updateRelationship(factionName, type, index, newValue) {
            worldData.relationships[factionName][type][index] = newValue;
        }

        function removeRelationship(factionName, type, index) {
            worldData.relationships[factionName][type].splice(index, 1);
            renderRelationships();
        }

        function saveWorld() {
            // Update world data from form
            worldData.worldName = document.getElementById("worldName").value || "Unnamed World";
            worldData.theme.fontFamily = document.getElementById("fontFamily").value;
            worldData.theme.bgColor1 = document.getElementById("bgColor1").value;
            worldData.theme.bgColor2 = document.getElementById("bgColor2").value;
            worldData.theme.textColor = document.getElementById("textColor").value;
            worldData.theme.headingColor = document.getElementById("headingColor").value;
            const tableBgRgb = hexToRgba(document.getElementById("tableBg").value, 0.9);
            worldData.theme.tableBg = tableBgRgb;
            worldData.theme.tableBorder = document.getElementById("tableBorder").value;
            worldData.theme.positiveColor1 = document.getElementById("positiveColor1").value;
            worldData.theme.positiveColor2 = document.getElementById("positiveColor2").value;
            worldData.theme.neutralColor1 = document.getElementById("neutralColor1").value;
            worldData.theme.neutralColor2 = document.getElementById("neutralColor2").value;
            worldData.theme.negativeColor1 = document.getElementById("negativeColor1").value;
            worldData.theme.negativeColor2 = document.getElementById("negativeColor2").value;
            
            localStorage.setItem("worldData", JSON.stringify(worldData));
            showMessage("World configuration saved!", "success");
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function exportWorld() {
            saveWorld(); // Save current state first
            const dataStr = JSON.stringify(worldData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${worldData.worldName.replace(/[^a-z0-9]/gi, '_')}_world.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage("World exported successfully!", "success");
        }

        function importWorld() {
            document.getElementById("importFile").click();
        }

        function handleWorldImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.factions && imported.theme && imported.relationships) {
                        worldData = imported;
                        renderAll();
                        saveWorld();
                        showMessage("World imported successfully!", "success");
                    } else {
                        showMessage("Invalid world file format.", "error");
                    }
                } catch (error) {
                    showMessage("Failed to import: " + error.message, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ""; // Reset file input
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById("message");
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            setTimeout(() => {
                msgDiv.textContent = "";
                msgDiv.className = "";
            }, 3000);
        }

        // Suggestion generation
        const suggestionTemplates = {
            "Pirate": {
                negative: [
                    { level: -100, text: "Pirate fleet relentlessly hunts the party." },
                    { level: -80, text: "Bounty issued; pirates target the party." },
                    { level: -60, text: "Frequent pirate ambushes." },
                    { level: -40, text: "Pirates demand gold or tribute." },
                    { level: -20, text: "Increased chance of pirate encounters." }
                ],
                positive: [
                    { level: 20, text: "Discounts on smuggled goods (20%)." },
                    { level: 40, text: "Safe passage in pirate-controlled areas." },
                    { level: 60, text: "Black-market goods provided at no cost." },
                    { level: 80, text: "Free crew recruitment." },
                    { level: 100, text: "Full pirate fleet support." }
                ]
            },
            "Naval": {
                negative: [
                    { level: -100, text: "Full bounty issued; attacked on sight." },
                    { level: -80, text: "Naval forces pursue the party aggressively." },
                    { level: -60, text: "Docking privileges denied." },
                    { level: -40, text: "Frequent inspections delay travel." },
                    { level: -20, text: "Naval forces are suspicious and unfriendly." }
                ],
                positive: [
                    { level: 20, text: "Minor supplies provided for free." },
                    { level: 40, text: "Discounted repairs (50%) at naval docks." },
                    { level: 60, text: "Access to naval intelligence." },
                    { level: 80, text: "Free ship upgrades." },
                    { level: 100, text: "Full naval support in conflicts." }
                ]
            },
            "Merchant": {
                negative: [
                    { level: -100, text: "Merchants sabotage the party's plans." },
                    { level: -80, text: "Trade routes blocked." },
                    { level: -60, text: "Merchants refuse to trade." },
                    { level: -40, text: "False rumors spread about the party." },
                    { level: -20, text: "Minor overcharging on goods/services." }
                ],
                positive: [
                    { level: 20, text: "Access to exclusive auctions." },
                    { level: 40, text: "Discounts on rare items (50%)." },
                    { level: 60, text: "Merchants broker alliances for the party." },
                    { level: 80, text: "Reveals hidden relic locations." },
                    { level: 100, text: "Free access to rare treasures." }
                ]
            },
            "Religious": {
                negative: [
                    { level: -100, text: "Declared heretics; full ban from area." },
                    { level: -80, text: "Religious authorities refuse to interact." },
                    { level: -60, text: "Temples block access." },
                    { level: -40, text: "Priests and merchants overcharge." },
                    { level: -20, text: "Locals are suspicious." }
                ],
                positive: [
                    { level: 20, text: "Access to festivals and blessings." },
                    { level: 40, text: "Discounts on magical rituals." },
                    { level: 60, text: "Free divine blessings." },
                    { level: 80, text: "Priests grant rare relics." },
                    { level: 100, text: "Full divine support for the party." }
                ]
            },
            "Criminal": {
                negative: [
                    { level: -100, text: "Criminal organization targets you for elimination." },
                    { level: -80, text: "Spies infiltrate your crew." },
                    { level: -60, text: "Criminal ambushes." },
                    { level: -40, text: "Criminals set traps." },
                    { level: -20, text: "Criminal agents monitor your movements." }
                ],
                positive: [
                    { level: 20, text: "Discounts on illegal goods (20%)." },
                    { level: 40, text: "Criminal contacts provide intelligence." },
                    { level: 60, text: "Access to criminal networks." },
                    { level: 80, text: "Secret routes revealed." },
                    { level: 100, text: "Criminal organization provides services." }
                ]
            },
            "Military": {
                negative: [
                    { level: -100, text: "Military declares you an enemy." },
                    { level: -80, text: "Military forces hunt you." },
                    { level: -60, text: "Military blocks your access." },
                    { level: -40, text: "Military inspections delay you." },
                    { level: -20, text: "Military is wary of you." }
                ],
                positive: [
                    { level: 20, text: "Minor military supplies provided." },
                    { level: 40, text: "Discounted military equipment." },
                    { level: 60, text: "Access to military intelligence." },
                    { level: 80, text: "Military provides protection." },
                    { level: 100, text: "Full military support in conflicts." }
                ]
            },
            "Magical": {
                negative: [
                    { level: -100, text: "Mages target you with powerful spells." },
                    { level: -80, text: "Allies turned against you by magic." },
                    { level: -60, text: "Navigation obscured by illusion magic." },
                    { level: -40, text: "Ambushes by enchanted forces." },
                    { level: -20, text: "Mages attempt to manipulate you." }
                ],
                positive: [
                    { level: 20, text: "Discounts on magic items." },
                    { level: 40, text: "Safe passage allowed." },
                    { level: 60, text: "Invitations to hidden sanctuaries." },
                    { level: 80, text: "Mages weave protective spells." },
                    { level: 100, text: "Access to powerful enchantments." }
                ]
            },
            "City": {
                negative: [
                    { level: -100, text: "City bars the party entry." },
                    { level: -80, text: "Residents alert hostile factions." },
                    { level: -60, text: "Guides and merchants refuse service." },
                    { level: -40, text: "Merchants overcharge (50% increase)." },
                    { level: -20, text: "Locals distrust the party." }
                ],
                positive: [
                    { level: 20, text: "Reduced cost for guides and maps." },
                    { level: 40, text: "Discounts on local goods." },
                    { level: 60, text: "Free guides and equipment." },
                    { level: 80, text: "Local escorts provided." },
                    { level: 100, text: "Free lodging and supplies." }
                ]
            },
            "Noble": {
                negative: [
                    { level: -100, text: "Nobles declare you persona non grata." },
                    { level: -80, text: "Noble houses blacklist you from high society." },
                    { level: -60, text: "Nobles refuse to grant audiences." },
                    { level: -40, text: "Nobles spread rumors to damage your reputation." },
                    { level: -20, text: "Nobles treat you with cold disdain." }
                ],
                positive: [
                    { level: 20, text: "Minor noble favors granted." },
                    { level: 40, text: "Access to noble events and galas." },
                    { level: 60, text: "Nobles provide political support." },
                    { level: 80, text: "Noble houses offer alliances." },
                    { level: 100, text: "Granted noble title and full privileges." }
                ]
            },
            "Cult": {
                negative: [
                    { level: -100, text: "Cult declares you a heretic and enemy." },
                    { level: -80, text: "Cultists hunt you relentlessly." },
                    { level: -60, text: "Cultists perform dark rituals against you." },
                    { level: -40, text: "Cult spreads fear and suspicion about you." },
                    { level: -20, text: "Cultists watch you with suspicion." }
                ],
                positive: [
                    { level: 20, text: "Cultists provide minor information." },
                    { level: 40, text: "Access to cult sanctuaries." },
                    { level: 60, text: "Cultists perform rituals to aid you." },
                    { level: 80, text: "Initiated into cult secrets." },
                    { level: 100, text: "Elevated to cult leadership." }
                ]
            },
            "Trading": {
                negative: [
                    { level: -100, text: "Trading guilds ban you from all markets." },
                    { level: -80, text: "Merchants refuse all business with you." },
                    { level: -60, text: "Trade routes closed to you." },
                    { level: -40, text: "Merchants charge exorbitant prices." },
                    { level: -20, text: "Merchants are reluctant to deal." }
                ],
                positive: [
                    { level: 20, text: "Access to exclusive trading posts." },
                    { level: 40, text: "Discounts on trade goods (30%)." },
                    { level: 60, text: "Trading guilds share market intelligence." },
                    { level: 80, text: "Priority access to rare commodities." },
                    { level: 100, text: "Honorary membership in trading guilds." }
                ]
            },
            "Warrior": {
                negative: [
                    { level: -100, text: "Warriors declare you a sworn enemy." },
                    { level: -80, text: "Warrior bands hunt you for sport." },
                    { level: -60, text: "Warriors challenge you to deadly duels." },
                    { level: -40, text: "Warriors spread tales of your cowardice." },
                    { level: -20, text: "Warriors mock and belittle you." }
                ],
                positive: [
                    { level: 20, text: "Warriors respect your combat prowess." },
                    { level: 40, text: "Access to warrior training grounds." },
                    { level: 60, text: "Warriors offer to fight alongside you." },
                    { level: 80, text: "Access to legendary weapons and armor." },
                    { level: 100, text: "Declared champion and granted warrior title." }
                ]
            },
            "Scholar": {
                negative: [
                    { level: -100, text: "Scholars declare your research heretical." },
                    { level: -80, text: "Libraries and academies ban you." },
                    { level: -60, text: "Scholars refuse to share knowledge." },
                    { level: -40, text: "Scholars spread false information about you." },
                    { level: -20, text: "Scholars are dismissive of your questions." }
                ],
                positive: [
                    { level: 20, text: "Scholars share basic information." },
                    { level: 40, text: "Access to restricted libraries." },
                    { level: 60, text: "Scholars provide rare knowledge." },
                    { level: 80, text: "Invited to exclusive academic circles." },
                    { level: 100, text: "Granted access to ancient and forbidden texts." }
                ]
            },
            "Assassin": {
                negative: [
                    { level: -100, text: "Assassins place a contract on your life." },
                    { level: -80, text: "Assassins actively hunt you." },
                    { level: -60, text: "Assassins attempt to poison you." },
                    { level: -40, text: "Assassins sabotage your plans." },
                    { level: -20, text: "Assassins watch you from the shadows." }
                ],
                positive: [
                    { level: 20, text: "Assassins ignore you." },
                    { level: 40, text: "Assassins share basic intelligence." },
                    { level: 60, text: "Access to assassination services." },
                    { level: 80, text: "Assassins provide protection." },
                    { level: 100, text: "Honorary member of the assassins' guild." }
                ]
            },
            "Thief": {
                negative: [
                    { level: -100, text: "Thieves' guild marks you for death." },
                    { level: -80, text: "Thieves constantly rob you." },
                    { level: -60, text: "Thieves sabotage your equipment." },
                    { level: -40, text: "Thieves spread rumors about your wealth." },
                    { level: -20, text: "Thieves target you for pickpocketing." }
                ],
                positive: [
                    { level: 20, text: "Thieves leave you alone." },
                    { level: 40, text: "Thieves share information about targets." },
                    { level: 60, text: "Access to stolen goods markets." },
                    { level: 80, text: "Thieves provide lockpicking services." },
                    { level: 100, text: "Honorary member of the thieves' guild." }
                ]
            },
            "Mercenary": {
                negative: [
                    { level: -100, text: "Mercenaries are hired to eliminate you." },
                    { level: -80, text: "Mercenary companies hunt you." },
                    { level: -60, text: "Mercenaries refuse to work with you." },
                    { level: -40, text: "Mercenaries charge exorbitant rates." },
                    { level: -20, text: "Mercenaries are untrustworthy around you." }
                ],
                positive: [
                    { level: 20, text: "Mercenaries offer standard rates." },
                    { level: 40, text: "Discounts on mercenary services (25%)." },
                    { level: 60, text: "Mercenaries provide reliable protection." },
                    { level: 80, text: "Access to elite mercenary companies." },
                    { level: 100, text: "Mercenaries fight for you at no cost." }
                ]
            },
            "Explorer": {
                negative: [
                    { level: -100, text: "Explorers sabotage your expeditions." },
                    { level: -80, text: "Explorers refuse to share maps." },
                    { level: -60, text: "Explorers spread false information." },
                    { level: -40, text: "Explorers charge high prices for guides." },
                    { level: -20, text: "Explorers are reluctant to help." }
                ],
                positive: [
                    { level: 20, text: "Explorers share basic maps." },
                    { level: 40, text: "Access to detailed exploration reports." },
                    { level: 60, text: "Explorers guide you to hidden locations." },
                    { level: 80, text: "Access to secret routes and shortcuts." },
                    { level: 100, text: "Explorers share all discovered treasures." }
                ]
            },
            "Diplomat": {
                negative: [
                    { level: -100, text: "Diplomats work against you in all negotiations." },
                    { level: -80, text: "Diplomatic channels closed to you." },
                    { level: -60, text: "Diplomats spread negative propaganda." },
                    { level: -40, text: "Diplomats refuse to meet with you." },
                    { level: -20, text: "Diplomats are cold and unhelpful." }
                ],
                positive: [
                    { level: 20, text: "Diplomats provide basic introductions." },
                    { level: 40, text: "Access to diplomatic circles." },
                    { level: 60, text: "Diplomats broker important alliances." },
                    { level: 80, text: "Diplomatic immunity granted." },
                    { level: 100, text: "Honored as a master diplomat." }
                ]
            },
            "Artisan": {
                negative: [
                    { level: -100, text: "Artisans refuse to work for you." },
                    { level: -80, text: "Guilds blacklist you from services." },
                    { level: -60, text: "Artisans sabotage your orders." },
                    { level: -40, text: "Artisans charge triple prices." },
                    { level: -20, text: "Artisans are slow and uncooperative." }
                ],
                positive: [
                    { level: 20, text: "Artisans provide standard services." },
                    { level: 40, text: "Discounts on crafted items (30%)." },
                    { level: 60, text: "Access to master craftsmen." },
                    { level: 80, text: "Artisans create custom masterpieces." },
                    { level: 100, text: "Honorary guild member with free services." }
                ]
            },
            "Mystical": {
                negative: [
                    { level: -100, text: "Mystical forces curse you." },
                    { level: -80, text: "Mystical barriers block your path." },
                    { level: -60, text: "Mystical entities harass you." },
                    { level: -40, text: "Mystical visions mislead you." },
                    { level: -20, text: "Mystical energies feel hostile." }
                ],
                positive: [
                    { level: 20, text: "Mystical forces are neutral." },
                    { level: 40, text: "Mystical visions guide you." },
                    { level: 60, text: "Access to mystical sanctuaries." },
                    { level: 80, text: "Mystical entities aid you." },
                    { level: 100, text: "Blessed by mystical powers." }
                ]
            },
            "Ancient": {
                negative: [
                    { level: -100, text: "Ancient guardians hunt you." },
                    { level: -80, text: "Ancient ruins are sealed from you." },
                    { level: -60, text: "Ancient curses affect you." },
                    { level: -40, text: "Ancient knowledge is hidden from you." },
                    { level: -20, text: "Ancient sites feel unwelcoming." }
                ],
                positive: [
                    { level: 20, text: "Ancient sites allow basic access." },
                    { level: 40, text: "Ancient guardians provide guidance." },
                    { level: 60, text: "Access to ancient libraries." },
                    { level: 80, text: "Ancient secrets revealed to you." },
                    { level: 100, text: "Honored as keeper of ancient wisdom." }
                ]
            },
            "Corrupt": {
                negative: [
                    { level: -100, text: "Corrupt officials frame you for crimes." },
                    { level: -80, text: "Corrupt networks target you." },
                    { level: -60, text: "Corrupt officials demand bribes." },
                    { level: -40, text: "Corrupt systems work against you." },
                    { level: -20, text: "Corrupt officials are unhelpful." }
                ],
                positive: [
                    { level: 20, text: "Corrupt officials ignore you." },
                    { level: 40, text: "Corrupt networks provide information." },
                    { level: 60, text: "Access to corrupt networks." },
                    { level: 80, text: "Corrupt officials grant favors." },
                    { level: 100, text: "Integrated into corrupt power structure." }
                ]
            },
            "Lawful": {
                negative: [
                    { level: -100, text: "Lawful authorities declare you an outlaw." },
                    { level: -80, text: "Lawful forces hunt you." },
                    { level: -60, text: "Lawful officials deny you services." },
                    { level: -40, text: "Lawful authorities are suspicious." },
                    { level: -20, text: "Lawful officials are uncooperative." }
                ],
                positive: [
                    { level: 20, text: "Lawful authorities treat you fairly." },
                    { level: 40, text: "Access to lawful services and protection." },
                    { level: 60, text: "Lawful authorities provide support." },
                    { level: 80, text: "Granted legal privileges and immunities." },
                    { level: 100, text: "Honored as a champion of law and order." }
                ]
            },
            "Chaotic": {
                negative: [
                    { level: -100, text: "Chaotic forces actively work against you." },
                    { level: -80, text: "Chaotic agents sabotage your plans." },
                    { level: -60, text: "Chaotic forces create obstacles." },
                    { level: -40, text: "Chaotic agents spread disorder around you." },
                    { level: -20, text: "Chaotic forces are unpredictable." }
                ],
                positive: [
                    { level: 20, text: "Chaotic forces leave you alone." },
                    { level: 40, text: "Chaotic agents provide information." },
                    { level: 60, text: "Access to chaotic networks." },
                    { level: 80, text: "Chaotic forces aid your plans." },
                    { level: 100, text: "Embraced as an agent of chaos." }
                ]
            },
            "Neutral": {
                negative: [
                    { level: -100, text: "Neutral parties actively avoid you." },
                    { level: -80, text: "Neutral forces refuse to interact." },
                    { level: -60, text: "Neutral parties are unhelpful." },
                    { level: -40, text: "Neutral forces are indifferent." },
                    { level: -20, text: "Neutral parties are distant." }
                ],
                positive: [
                    { level: 20, text: "Neutral parties are friendly." },
                    { level: 40, text: "Neutral forces provide basic aid." },
                    { level: 60, text: "Neutral parties offer balanced support." },
                    { level: 80, text: "Neutral forces grant favors." },
                    { level: 100, text: "Respected as a balanced mediator." }
                ]
            }
        };

        function generateSuggestions(factionIndex) {
            const faction = worldData.factions[factionIndex];
            const descriptors = faction.descriptors || [];
            
            if (descriptors.length === 0) {
                alert("Please select at least one descriptor to generate suggestions.");
                return;
            }

            const suggestions = {};
            const allSuggestions = {}; // Collect all suggestions per level

            // Collect suggestions from all selected descriptors
            descriptors.forEach(desc => {
                const template = suggestionTemplates[desc];
                if (template) {
                    template.negative.forEach(item => {
                        if (!allSuggestions[item.level]) {
                            allSuggestions[item.level] = [];
                        }
                        allSuggestions[item.level].push(item.text);
                    });
                    template.positive.forEach(item => {
                        if (!allSuggestions[item.level]) {
                            allSuggestions[item.level] = [];
                        }
                        allSuggestions[item.level].push(item.text);
                    });
                }
            });

            // For each level, pick the best suggestion or combine them
            Object.keys(allSuggestions).forEach(level => {
                const levelSuggestions = allSuggestions[level];
                if (levelSuggestions.length === 1) {
                    suggestions[level] = levelSuggestions[0];
                } else {
                    // If multiple descriptors, prefer more specific ones or combine concepts
                    // For now, randomly pick one, but you could make this smarter
                    suggestions[level] = levelSuggestions[Math.floor(Math.random() * levelSuggestions.length)];
                }
            });

            // Add neutral suggestion if missing
            if (!suggestions[0]) {
                const neutralTexts = [
                    "Neutral stance; standard behavior.",
                    "Neutral stance; they observe you.",
                    "Neutral stance; no special treatment.",
                    "Neutral stance; standard services."
                ];
                suggestions[0] = neutralTexts[Math.floor(Math.random() * neutralTexts.length)];
            }

            // Ensure we have suggestions for all standard levels
            const standardLevels = [-100, -80, -60, -40, -20, 0, 20, 40, 60, 80, 100];
            standardLevels.forEach(level => {
                if (!suggestions[level]) {
                    // Generate a generic suggestion based on descriptors
                    const isNegative = level < 0;
                    const isCity = descriptors.includes("City");
                    const isPirate = descriptors.includes("Pirate");
                    const isMerchant = descriptors.includes("Merchant");
                    const isReligious = descriptors.includes("Religious");
                    
                    if (isNegative) {
                        if (isCity) {
                            suggestions[level] = `City residents become increasingly hostile.`;
                        } else if (isPirate) {
                            suggestions[level] = `Pirates target the party more frequently.`;
                        } else if (isMerchant) {
                            suggestions[level] = `Merchants refuse to deal with the party.`;
                        } else {
                            suggestions[level] = `The faction becomes increasingly hostile.`;
                        }
                    } else if (level > 0) {
                        if (isCity) {
                            suggestions[level] = `City provides better services and discounts.`;
                        } else if (isPirate) {
                            suggestions[level] = `Pirates offer better deals and safe passage.`;
                        } else if (isMerchant) {
                            suggestions[level] = `Merchants offer exclusive deals and rare goods.`;
                        } else if (isReligious) {
                            suggestions[level] = `Religious authorities grant blessings and access.`;
                        } else {
                            suggestions[level] = `The faction provides increasing benefits.`;
                        }
                    }
                }
            });

            // Display suggestions in modal
            showSuggestionsModal(factionIndex, faction.name, suggestions);
        }

        let currentSuggestions = {}; // Store suggestions globally for applyAll

        function showSuggestionsModal(factionIndex, factionName, suggestions) {
            const modal = document.getElementById("suggestionsModal");
            const content = document.getElementById("suggestionsContent");
            const title = document.getElementById("modalTitle");
            
            // Store suggestions globally
            currentSuggestions = { ...suggestions };
            modal.setAttribute('data-faction-index', factionIndex);
            
            title.textContent = `Bonus Suggestions for ${factionName}`;
            content.innerHTML = "";
            
            const sortedLevels = Object.keys(suggestions).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedLevels.forEach(level => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                const escapedText = suggestions[level].replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                div.innerHTML = `
                    <h4>Renown Level: ${level}</h4>
                    <p>${suggestions[level]}</p>
                    <button onclick="applySuggestion(${factionIndex}, ${level}, '${escapedText}')">Apply This Suggestion</button>
                `;
                content.appendChild(div);
            });

            // Add "Apply All" button
            const applyAllDiv = document.createElement("div");
            applyAllDiv.style.textAlign = "center";
            applyAllDiv.style.marginTop = "20px";
            const applyAllBtn = document.createElement("button");
            applyAllBtn.className = "success";
            applyAllBtn.textContent = "Apply All Suggestions";
            applyAllBtn.onclick = () => applyAllSuggestions(factionIndex);
            applyAllDiv.appendChild(applyAllBtn);
            content.appendChild(applyAllDiv);

            modal.style.display = "block";
        }

        function closeSuggestionsModal() {
            document.getElementById("suggestionsModal").style.display = "none";
        }

        function applySuggestion(factionIndex, level, text) {
            if (!worldData.factions[factionIndex].bonuses) {
                worldData.factions[factionIndex].bonuses = {};
            }
            // Unescape HTML entities
            const unescapedText = text.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
            worldData.factions[factionIndex].bonuses[level] = unescapedText;
            renderFactions();
            showMessage("Suggestion applied!", "success");
        }

        function applyAllSuggestions(factionIndex) {
            if (!worldData.factions[factionIndex].bonuses) {
                worldData.factions[factionIndex].bonuses = {};
            }
            Object.keys(currentSuggestions).forEach(level => {
                worldData.factions[factionIndex].bonuses[level] = currentSuggestions[level];
            });
            renderFactions();
            closeSuggestionsModal();
            showMessage("All suggestions applied!", "success");
        }

        // Note: window.onclick handler is defined later to handle both modals

        // Tab switching
        function switchTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Collapsible sections
        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        // Faction collapse
        function toggleFaction(index) {
            const content = document.getElementById(`faction-content-${index}`);
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        // Relationship collapse
        function toggleRelationship(factionName) {
            const content = document.getElementById(`relationship-content-${factionName}`);
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        // Relationship Graph Functions
        let graphNetwork = null;

        function showRelationshipGraph() {
            const modal = document.getElementById("graphModal");
            modal.style.display = "block";
            
            // Wait a bit for modal to render, then create graph
            setTimeout(() => {
                createRelationshipGraph();
            }, 100);
        }

        function closeGraphModal() {
            document.getElementById("graphModal").style.display = "none";
            if (graphNetwork) {
                graphNetwork.destroy();
                graphNetwork = null;
            }
        }

        function createRelationshipGraph() {
            const container = document.getElementById("relationshipGraph");
            if (!container) return;

            // Clear previous graph
            if (graphNetwork) {
                graphNetwork.destroy();
            }

            // Prepare nodes (factions/cities)
            const nodes = [];
            const nodeMap = {};
            
            worldData.factions.forEach((faction, index) => {
                const isCity = faction.name.startsWith("City:");
                const nodeId = index;
                nodeMap[faction.name] = nodeId;
                
                // Count bonuses
                const bonusCount = Object.keys(faction.bonuses || {}).length;
                
                // Create tooltip with bonus info
                const bonusLevels = Object.keys(faction.bonuses || {}).sort((a, b) => parseInt(a) - parseInt(b));
                const bonusPreview = bonusLevels.slice(0, 3).map(level => {
                    const bonus = faction.bonuses[level];
                    return `Level ${level}: ${bonus.substring(0, 50)}${bonus.length > 50 ? '...' : ''}`;
                }).join('\n');
                
                const tooltip = `${faction.name}\n\nBonuses: ${bonusCount} levels\n\n${bonusPreview}${bonusLevels.length > 3 ? '\n...' : ''}`;
                
                nodes.push({
                    id: nodeId,
                    label: faction.name.replace("City: ", ""),
                    title: tooltip,
                    color: {
                        background: isCity ? "#ffdd8b" : "#4a9eff",
                        border: isCity ? "#ffaa00" : "#2e6bb3",
                        highlight: {
                            background: isCity ? "#ffed99" : "#6bb0ff",
                            border: isCity ? "#ffaa00" : "#2e6bb3"
                        }
                    },
                    shape: isCity ? "diamond" : "dot",
                    size: 25,
                    font: {
                        size: 14,
                        color: "#e0e0e0"
                    }
                });
            });

            // Prepare edges (relationships)
            const edges = [];
            const edgeMap = {}; // Track edges to avoid duplicates
            
            Object.keys(worldData.relationships || {}).forEach(factionName => {
                const fromId = nodeMap[factionName];
                if (fromId === undefined) return;
                
                const relationships = worldData.relationships[factionName];
                
                // Friend relationships (green)
                (relationships.friends || []).forEach(friendName => {
                    const toId = nodeMap[friendName];
                    if (toId !== undefined) {
                        const edgeKey = `${Math.min(fromId, toId)}-${Math.max(fromId, toId)}-friend`;
                        if (!edgeMap[edgeKey]) {
                            edges.push({
                                from: fromId,
                                to: toId,
                                color: {
                                    color: "#28a745",
                                    highlight: "#4caf50",
                                    hover: "#4caf50"
                                },
                                width: 3,
                                dashes: false,
                                title: `${factionName} ‚Üî ${friendName} (Friends)`,
                                arrows: {
                                    to: {
                                        enabled: false
                                    }
                                }
                            });
                            edgeMap[edgeKey] = true;
                        }
                    }
                });
                
                // Enemy relationships (red)
                (relationships.enemies || []).forEach(enemyName => {
                    const toId = nodeMap[enemyName];
                    if (toId !== undefined) {
                        const edgeKey = `${Math.min(fromId, toId)}-${Math.max(fromId, toId)}-enemy`;
                        if (!edgeMap[edgeKey]) {
                            edges.push({
                                from: fromId,
                                to: toId,
                                color: {
                                    color: "#dc3545",
                                    highlight: "#f44336",
                                    hover: "#f44336"
                                },
                                width: 3,
                                dashes: [5, 5], // Dashed line for enemies
                                title: `${factionName} ‚Üî ${enemyName} (Enemies)`,
                                arrows: {
                                    to: {
                                        enabled: false
                                    }
                                }
                            });
                            edgeMap[edgeKey] = true;
                        }
                    }
                });
            });

            // Graph data
            const data = {
                nodes: nodes,
                edges: edges
            };

            // Graph options
            const options = {
                nodes: {
                    borderWidth: 2,
                    shadow: true,
                    font: {
                        size: 14,
                        face: "'IM Fell English SC', serif"
                    }
                },
                edges: {
                    smooth: {
                        type: "continuous",
                        roundness: 0.5
                    },
                    shadow: true
                },
                physics: {
                    enabled: true,
                    stabilization: {
                        enabled: true,
                        iterations: 200
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.1,
                        springLength: 200,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    zoomView: true,
                    dragView: true
                },
                layout: {
                    improvedLayout: true
                }
            };

            // Create network
            graphNetwork = new vis.Network(container, data, options);
            
            // Add click handler to show detailed info
            graphNetwork.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const faction = worldData.factions[nodeId];
                    if (faction) {
                        showFactionDetails(faction);
                    }
                }
            });
        }

        function showFactionDetails(faction) {
            const bonusLevels = Object.keys(faction.bonuses || {}).sort((a, b) => parseInt(a) - parseInt(b));
            let bonusText = `<strong>${faction.name}</strong><br><br><strong>Bonuses/Penalties:</strong><br>`;
            
            bonusLevels.forEach(level => {
                const bonus = faction.bonuses[level];
                const color = parseInt(level) < 0 ? "#dc3545" : parseInt(level) > 0 ? "#28a745" : "#4682b4";
                bonusText += `<span style="color: ${color};">Level ${level}:</span> ${bonus}<br>`;
            });
            
            // Show in a simple alert or create a better modal
            const detailsDiv = document.createElement("div");
            detailsDiv.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; border: 2px solid #4a9eff; border-radius: 10px; padding: 20px; max-width: 600px; max-height: 70vh; overflow-y: auto; z-index: 3000; color: #e0e0e0;";
            detailsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #4a9eff;">Faction Details</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #dc3545; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">√ó</button>
                </div>
                ${bonusText}
            `;
            document.body.appendChild(detailsDiv);
            
            // Auto-remove after 10 seconds or on click outside
            setTimeout(() => {
                if (detailsDiv.parentElement) {
                    detailsDiv.remove();
                }
            }, 10000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const graphModal = document.getElementById("graphModal");
            const suggestionsModal = document.getElementById("suggestionsModal");
            if (event.target === graphModal) {
                closeGraphModal();
            }
            if (event.target === suggestionsModal) {
                closeSuggestionsModal();
            }
        }

        //========================================
        // REGIONAL POWER DYNAMICS
        //========================================

        // Regional data storage
        let regionalData = {
            regions: {},
            factionDetails: {}
        };

        // Regional Factions Manager (standalone version)
        class RegionalFactionsManager {
            constructor() {
                this.interactions = {
                    war: { powerEffect: -10, description: 'is at war with' },
                    alliance: { powerEffect: 5, description: 'is allied with' },
                    trade: { powerEffect: 3, description: 'has a trade agreement with' }
                };
                this.eventLog = [];
            }

            setRegion(regionalData, regionName, authority = 0) {
                if (!regionalData.regions[regionName]) {
                    regionalData.regions[regionName] = {
                        authority: authority,
                        factions: []
                    };
                } else {
                    regionalData.regions[regionName].authority = authority;
                }
                return regionalData;
            }

            addFactionToRegion(regionalData, regionName, factionName, details = {}) {
                if (!regionalData.regions[regionName]) {
                    this.setRegion(regionalData, regionName, 0);
                }

                const faction = {
                    name: factionName,
                    power: 50,
                    interactions: [],
                    leader: details.leader || 'Unknown',
                    description: details.description || 'No description',
                    goals: details.goals || 'No goals'
                };

                regionalData.regions[regionName].factions.push(faction);

                if (!regionalData.factionDetails[factionName]) {
                    regionalData.factionDetails[factionName] = { regions: [] };
                }
                regionalData.factionDetails[factionName].regions.push(regionName);

                this.balancePower(regionalData, regionName);
                return regionalData;
            }

            removeFactionFromRegion(regionalData, regionName, factionName) {
                if (!regionalData.regions[regionName]) return regionalData;

                const index = regionalData.regions[regionName].factions.findIndex(f => f.name === factionName);
                if (index !== -1) {
                    regionalData.regions[regionName].factions.splice(index, 1);

                    if (regionalData.factionDetails[factionName]) {
                        const regionIndex = regionalData.factionDetails[factionName].regions.indexOf(regionName);
                        if (regionIndex !== -1) {
                            regionalData.factionDetails[factionName].regions.splice(regionIndex, 1);
                        }
                        if (regionalData.factionDetails[factionName].regions.length === 0) {
                            delete regionalData.factionDetails[factionName];
                        }
                    }

                    this.balancePower(regionalData, regionName);
                }
                return regionalData;
            }

            setInteraction(regionalData, regionA, factionA, regionB, factionB, type) {
                if (!this.interactions[type]) return regionalData;

                const factionAObj = this.getFaction(regionalData, regionA, factionA);
                const factionBObj = this.getFaction(regionalData, regionB, factionB);

                if (factionAObj && factionBObj) {
                    const existingA = factionAObj.interactions.findIndex(i => i.target === factionB && i.region === regionB);
                    const existingB = factionBObj.interactions.findIndex(i => i.target === factionA && i.region === regionA);

                    if (existingA !== -1) {
                        factionAObj.interactions[existingA].type = type;
                    } else {
                        factionAObj.interactions.push({ type: type, target: factionB, region: regionB });
                    }

                    if (existingB !== -1) {
                        factionBObj.interactions[existingB].type = type;
                    } else {
                        factionBObj.interactions.push({ type: type, target: factionA, region: regionA });
                    }
                }
                return regionalData;
            }

            removeInteraction(regionalData, regionA, factionA, regionB, factionB) {
                const factionAObj = this.getFaction(regionalData, regionA, factionA);
                const factionBObj = this.getFaction(regionalData, regionB, factionB);

                if (factionAObj) {
                    factionAObj.interactions = factionAObj.interactions.filter(i => !(i.target === factionB && i.region === regionB));
                }
                if (factionBObj) {
                    factionBObj.interactions = factionBObj.interactions.filter(i => !(i.target === factionA && i.region === regionA));
                }
                return regionalData;
            }

            getFaction(regionalData, regionName, factionName) {
                if (!regionalData.regions[regionName]) return null;
                return regionalData.regions[regionName].factions.find(f => f.name === factionName);
            }

            balancePower(regionalData, regionName) {
                const region = regionalData.regions[regionName];
                if (!region) return regionalData;

                const totalFactions = region.factions.length;
                const availablePower = 100 - region.authority;

                if (totalFactions > 0 && availablePower >= 0) {
                    let totalPower = region.factions.reduce((sum, faction) => sum + faction.power, 0);

                    if (totalPower > availablePower) {
                        region.factions.forEach(faction => {
                            faction.power = (faction.power / totalPower) * availablePower;
                        });
                    } else if (totalPower < availablePower) {
                        const powerPerFaction = availablePower / totalFactions;
                        region.factions.forEach(faction => faction.power = powerPerFaction);
                    }
                }
                return regionalData;
            }

            rollDice(regionalData) {
                const logEntries = [];

                for (const regionName in regionalData.regions) {
                    const region = regionalData.regions[regionName];
                    const totalPower = 100 - region.authority;

                    if (region.factions.length > 1) {
                        region.factions.forEach(faction => {
                            const powerChange = Math.floor(Math.random() * 21) - 10;
                            faction.power += powerChange;
                            if (faction.power < 0) faction.power = 0;

                            logEntries.push({
                                region: regionName,
                                message: `${faction.name} power changed by ${powerChange > 0 ? '+' : ''}${powerChange}`
                            });

                            faction.interactions.forEach(interaction => {
                                const effect = this.interactions[interaction.type];
                                const targetFaction = this.getFaction(regionalData, interaction.region, interaction.target);

                                if (targetFaction && effect) {
                                    faction.power += effect.powerEffect;
                                    logEntries.push({
                                        region: regionName,
                                        message: `${faction.name} ${effect.description} ${targetFaction.name}`
                                    });
                                }
                            });
                        });

                        let currentTotalPower = region.factions.reduce((sum, faction) => sum + faction.power, 0);
                        let iterations = 0;
                        const maxIterations = 100;

                        while (Math.abs(currentTotalPower - totalPower) > 0.1 && iterations < maxIterations) {
                            const difference = currentTotalPower - totalPower;
                            const adjustFaction = region.factions[Math.floor(Math.random() * region.factions.length)];

                            adjustFaction.power -= difference / region.factions.length;
                            if (adjustFaction.power < 0) adjustFaction.power = 0;

                            currentTotalPower = region.factions.reduce((sum, faction) => sum + faction.power, 0);
                            iterations++;
                        }

                        this.balancePower(regionalData, regionName);
                    }
                }

                this.eventLog = [...this.eventLog, ...logEntries];
                return logEntries;
            }

            clearEventLog() {
                this.eventLog = [];
            }
        }

        const regionalFactionsManager = new RegionalFactionsManager();

        // Load regional data from localStorage
        function loadRegionalData() {
            const saved = localStorage.getItem("regionalData");
            if (saved) {
                try {
                    regionalData = JSON.parse(saved);
                } catch (e) {
                    console.error("Error loading regional data:", e);
                    regionalData = { regions: {}, factionDetails: {} };
                }
            }
        }

        // Save regional data to localStorage
        function saveRegionalData() {
            localStorage.setItem("regionalData", JSON.stringify(regionalData));
        }

        // Add region
        function addRegion() {
            const regionName = document.getElementById("newRegionName").value.trim();
            const authority = parseInt(document.getElementById("newRegionAuthority").value) || 20;

            if (!regionName) {
                showMessage("Please enter a region name", "error");
                return;
            }

            if (regionalData.regions[regionName]) {
                showMessage("Region already exists", "error");
                return;
            }

            regionalFactionsManager.setRegion(regionalData, regionName, authority);
            saveRegionalData();
            renderRegions();
            showMessage(`Region "${regionName}" added`, "success");

            document.getElementById("newRegionName").value = "";
        }

        // Assign faction to region
        function assignFactionToRegion() {
            const factionName = document.getElementById("factionSelectForRegion").value;
            const regionName = document.getElementById("regionSelectForFaction").value;
            const leader = document.getElementById("factionLeader").value.trim();
            const description = document.getElementById("factionDescription").value.trim();
            const goals = document.getElementById("factionGoals").value.trim();

            if (!factionName || !regionName) {
                showMessage("Please select both a faction and a region", "error");
                return;
            }

            const region = regionalData.regions[regionName];
            if (region && region.factions.find(f => f.name === factionName)) {
                showMessage("Faction already exists in this region", "error");
                return;
            }

            regionalFactionsManager.addFactionToRegion(regionalData, regionName, factionName, {
                leader, description, goals
            });

            saveRegionalData();
            renderRegions();
            showMessage(`Faction "${factionName}" assigned to "${regionName}"`, "success");

            document.getElementById("factionLeader").value = "";
            document.getElementById("factionDescription").value = "";
            document.getElementById("factionGoals").value = "";
        }

        // Set faction interaction
        function setFactionInteraction() {
            const factionAValue = document.getElementById("factionASelect").value;
            const factionBValue = document.getElementById("factionBSelect").value;
            const interactionType = document.getElementById("interactionTypeSelect").value;

            if (!factionAValue || !factionBValue) {
                showMessage("Please select both factions", "error");
                return;
            }

            const [regionA, factionA] = factionAValue.split(':');
            const [regionB, factionB] = factionBValue.split(':');

            if (regionA === regionB && factionA === factionB) {
                showMessage("Cannot create interaction with the same faction", "error");
                return;
            }

            regionalFactionsManager.setInteraction(regionalData, regionA, factionA, regionB, factionB, interactionType);
            saveRegionalData();
            renderRegions();
            showMessage(`Interaction set between "${factionA}" and "${factionB}"`, "success");
        }

        // Roll dice for power simulation
        function rollDiceRegional() {
            const logEntries = regionalFactionsManager.rollDice(regionalData);
            saveRegionalData();
            renderRegions();

            const eventLog = document.getElementById("eventLog");
            eventLog.innerHTML = "";

            if (logEntries.length > 0) {
                logEntries.forEach(entry => {
                    const div = document.createElement("div");
                    div.style.padding = "6px";
                    div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
                    div.innerHTML = `<span style="font-weight: bold; color: #4a9eff;">[${entry.region}]</span> ${entry.message}`;
                    eventLog.appendChild(div);
                });
            } else {
                eventLog.innerHTML = '<p style="opacity: 0.6; font-style: italic; text-align: center;">No significant changes occurred.</p>';
            }

            showMessage("Power dynamics updated!", "success");
        }

        // Clear event log
        function clearEventLog() {
            regionalFactionsManager.clearEventLog();
            document.getElementById("eventLog").innerHTML = '<p style="opacity: 0.6; font-style: italic; text-align: center;">No events yet. Roll the dice to simulate power changes.</p>';
        }

        // Export regional data
        function exportRegionalData() {
            const jsonData = JSON.stringify(regionalData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'regional-factions-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Regional data exported!", "success");
        }

        // Import regional data
        function importRegionalData() {
            document.getElementById("importRegionalFile").click();
        }

        function handleRegionalImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    regionalData = importedData;

                    // Rebalance all regions
                    for (const regionName in regionalData.regions) {
                        regionalFactionsManager.balancePower(regionalData, regionName);
                    }

                    saveRegionalData();
                    renderRegions();
                    showMessage("Regional data imported successfully!", "success");
                } catch (error) {
                    console.error("Import error:", error);
                    showMessage("Error importing regional data", "error");
                }
            };
            reader.readAsText(file);
        }

        // Render regions
        function renderRegions() {
            const container = document.getElementById("regionsContainer");
            container.innerHTML = "";

            // Update region/faction selects
            updateRegionalSelects();

            if (Object.keys(regionalData.regions).length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; opacity: 0.7;">No regions defined. Add a region to get started.</p>';
                return;
            }

            for (const regionName in regionalData.regions) {
                const region = regionalData.regions[regionName];
                const regionCard = createRegionCard(regionName, region);
                container.appendChild(regionCard);
            }
        }

        function createRegionCard(regionName, region) {
            const card = document.createElement("div");
            card.style.cssText = "background: rgba(0,0,0,0.3); border: 1px solid #4a9eff; border-radius: 8px; padding: 15px; margin-bottom: 15px;";

            let factionsHtml = "";
            if (region.factions.length > 0) {
                region.factions.forEach(faction => {
                    let interactionsHtml = "";
                    if (faction.interactions.length > 0) {
                        interactionsHtml = `<div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <strong style="font-size: 0.9em;">Interactions:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.85em;">
                                ${faction.interactions.map(int => {
                                    const color = int.type === 'war' ? '#e74c3c' : int.type === 'alliance' ? '#3498db' : '#f39c12';
                                    return `<li style="color: ${color};">
                                        ${regionalFactionsManager.interactions[int.type].description} ${int.target} (${int.region})
                                        <button onclick="removeInteraction('${regionName}', '${faction.name}', '${int.region}', '${int.target}')"
                                                style="margin-left: 5px; padding: 1px 4px; font-size: 0.7em; background: rgba(255,0,0,0.3); border: 1px solid #ff0000; border-radius: 2px; color: #fff; cursor: pointer;">√ó</button>
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>`;
                    }

                    factionsHtml += `<div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(74,158,255,0.3); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="margin: 0; color: #4a9eff;">${faction.name}</h4>
                            <button onclick="removeFactionFromRegion('${regionName}', '${faction.name}')"
                                    style="padding: 2px 6px; font-size: 0.8em; background: rgba(255,0,0,0.3); border: 1px solid #ff0000; border-radius: 3px; color: #fff; cursor: pointer;">√ó</button>
                        </div>
                        <div style="margin: 10px 0;">
                            <div style="width: 100%; height: 24px; background: rgba(0,0,0,0.4); border-radius: 4px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.2);">
                                <div style="height: 100%; width: ${faction.power}%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.4s ease;"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.85em; font-weight: bold; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">${faction.power.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div style="font-size: 0.85em; opacity: 0.95; line-height: 1.4;">
                            <p style="margin: 4px 0;"><strong>Leader:</strong> ${faction.leader || 'Unknown'}</p>
                            <p style="margin: 4px 0;"><strong>Description:</strong> ${faction.description || 'No description'}</p>
                            <p style="margin: 4px 0;"><strong>Goals:</strong> ${faction.goals || 'No goals'}</p>
                        </div>
                        ${interactionsHtml}
                    </div>`;
                });
            } else {
                factionsHtml = '<p style="opacity: 0.7; font-size: 0.9em;">No factions in this region</p>';
            }

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #4a9eff;">
                    <h3 style="margin: 0; color: #4a9eff;">${regionName}</h3>
                    <button onclick="removeRegion('${regionName}')"
                            style="padding: 4px 8px; font-size: 0.9em; background: rgba(255,0,0,0.2); border: 1px solid #ff4444; border-radius: 4px; color: #ff6666; cursor: pointer;">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <label style="display: block; font-size: 0.95em; margin-bottom: 8px;">
                        Authority/Lawfulness: <span style="font-weight: bold; color: #4a9eff;">${region.authority}%</span>
                    </label>
                    <input type="range" min="0" max="100" value="${region.authority}"
                           onchange="updateAuthority('${regionName}', this.value)"
                           style="width: 100%; cursor: pointer;">
                    <div style="text-align: center; font-size: 0.9em; margin-top: 6px; opacity: 0.8; font-style: italic;">
                        Faction Power Available: ${(100 - region.authority).toFixed(0)}%
                    </div>
                </div>
                ${factionsHtml}
            `;

            return card;
        }

        function updateAuthority(regionName, authority) {
            authority = parseInt(authority);
            regionalData.regions[regionName].authority = authority;
            regionalFactionsManager.balancePower(regionalData, regionName);
            saveRegionalData();
            renderRegions();
            showMessage(`Authority for "${regionName}" updated to ${authority}%`, "success");
        }

        function removeRegion(regionName) {
            if (!confirm(`Are you sure you want to remove the region "${regionName}" and all its factions?`)) {
                return;
            }

            delete regionalData.regions[regionName];
            saveRegionalData();
            renderRegions();
            showMessage(`Region "${regionName}" removed`, "success");
        }

        function removeFactionFromRegion(regionName, factionName) {
            if (!confirm(`Are you sure you want to remove "${factionName}" from "${regionName}"?`)) {
                return;
            }

            regionalFactionsManager.removeFactionFromRegion(regionalData, regionName, factionName);
            saveRegionalData();
            renderRegions();
            showMessage(`Faction "${factionName}" removed from "${regionName}"`, "success");
        }

        function removeInteraction(regionA, factionA, regionB, factionB) {
            regionalFactionsManager.removeInteraction(regionalData, regionA, factionA, regionB, factionB);
            saveRegionalData();
            renderRegions();
            showMessage("Interaction removed", "success");
        }

        function updateRegionalSelects() {
            // Update faction select for region assignment
            const factionSelect = document.getElementById("factionSelectForRegion");
            factionSelect.innerHTML = '<option value="">Select Faction...</option>';
            worldData.factions.forEach(faction => {
                const option = document.createElement("option");
                option.value = faction.name;
                option.textContent = faction.name;
                factionSelect.appendChild(option);
            });

            // Update region select
            const regionSelect = document.getElementById("regionSelectForFaction");
            regionSelect.innerHTML = '<option value="">Select Region...</option>';
            for (const regionName in regionalData.regions) {
                const option = document.createElement("option");
                option.value = regionName;
                option.textContent = regionName;
                regionSelect.appendChild(option);
            }

            // Update faction interaction selects
            const factionASelect = document.getElementById("factionASelect");
            const factionBSelect = document.getElementById("factionBSelect");
            factionASelect.innerHTML = '<option value="">Select Faction A...</option>';
            factionBSelect.innerHTML = '<option value="">Select Faction B...</option>';

            for (const regionName in regionalData.regions) {
                const region = regionalData.regions[regionName];
                region.factions.forEach(faction => {
                    const optionValue = `${regionName}:${faction.name}`;
                    const optionText = `${faction.name} (${regionName})`;

                    const optionA = document.createElement("option");
                    optionA.value = optionValue;
                    optionA.textContent = optionText;
                    factionASelect.appendChild(optionA);

                    const optionB = document.createElement("option");
                    optionB.value = optionValue;
                    optionB.textContent = optionText;
                    factionBSelect.appendChild(optionB);
                });
            }
        }

        // Initialize
        loadRegionalData();
        loadWorldData();
    </script>
</body>
</html>

