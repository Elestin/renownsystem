<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <title>World Configuration Admin</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'IM Fell English SC', serif;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #4a9eff;
            text-shadow: 2px 2px 5px #000;
            margin-bottom: 10px;
        }
        .nav-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-buttons button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit;
        }
        .nav-buttons button:hover {
            background: #6bb0ff;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a9eff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #4a9eff;
            margin-top: 0;
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #b0c4de;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-family: inherit;
        }
        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit;
            margin: 5px;
        }
        button:hover {
            background: #6bb0ff;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .faction-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #4a9eff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .faction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .faction-header h3 {
            margin: 0;
            color: #4a9eff;
        }
        .bonus-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .bonus-entry input[type="number"] {
            width: 100px;
        }
        .bonus-entry textarea {
            flex: 1;
        }
        .relationship-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .relationship-entry select {
            flex: 1;
        }
        .color-preview {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 1px solid #4a9eff;
            border-radius: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #4a9eff;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .message.success {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid #28a745;
        }
        .message.error {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid #dc3545;
        }
        .descriptor-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        .descriptor-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid #4a9eff;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .descriptor-tag .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .descriptor-tag .remove-btn:hover {
            background: #c82333;
        }
        .descriptor-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .descriptor-selector select {
            flex: 1;
        }
        .selected-descriptors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .suggestions-panel {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .suggestion-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .suggestion-item h4 {
            margin: 0 0 5px 0;
            color: #28a745;
        }
        .suggestion-item p {
            margin: 5px 0;
            color: #e0e0e0;
        }
        .suggestion-item button {
            background: #28a745;
            margin-top: 5px;
        }
        .suggestion-item button:hover {
            background: #218838;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background: #1a1a2e;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #4a9eff;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>World Configuration Admin</h1>
        <div class="nav-buttons">
            <button onclick="window.location.href='index.html'">View Main Tracker</button>
        </div>

        <div id="message"></div>

        <div class="section">
            <h2>World Settings</h2>
            <div class="form-group">
                <label>World Name:</label>
                <input type="text" id="worldName" placeholder="Enter world name">
            </div>
        </div>

        <div class="section">
            <h2>Theme & Styling</h2>
            <div class="two-column">
                <div class="form-group">
                    <label>Font Family:</label>
                    <select id="fontFamily">
                        <option value="'IM Fell English SC', serif">IM Fell English SC</option>
                        <option value="'Cinzel', serif">Cinzel</option>
                        <option value="'MedievalSharp', cursive">MedievalSharp</option>
                        <option value="'Uncial Antiqua', cursive">Uncial Antiqua</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Background Color (Top):</label>
                    <input type="color" id="bgColor1" value="#2e1a14">
                    <span class="color-preview" id="bgPreview1"></span>
                </div>
                <div class="form-group">
                    <label>Background Color (Bottom):</label>
                    <input type="color" id="bgColor2" value="#4a3326">
                    <span class="color-preview" id="bgPreview2"></span>
                </div>
                <div class="form-group">
                    <label>Text Color:</label>
                    <input type="color" id="textColor" value="#f8e8c0">
                    <span class="color-preview" id="textPreview"></span>
                </div>
                <div class="form-group">
                    <label>Heading Color:</label>
                    <input type="color" id="headingColor" value="#ffdd8b">
                    <span class="color-preview" id="headingPreview"></span>
                </div>
                <div class="form-group">
                    <label>Table Background:</label>
                    <input type="color" id="tableBg" value="#fff8e4">
                    <span class="color-preview" id="tableBgPreview"></span>
                </div>
                <div class="form-group">
                    <label>Table Border Color:</label>
                    <input type="color" id="tableBorder" value="#523c23">
                    <span class="color-preview" id="tableBorderPreview"></span>
                </div>
                <div class="form-group">
                    <label>Positive Renown Color (Start):</label>
                    <input type="color" id="positiveColor1" value="#2e8b57">
                    <span class="color-preview" id="positivePreview1"></span>
                </div>
                <div class="form-group">
                    <label>Positive Renown Color (End):</label>
                    <input type="color" id="positiveColor2" value="#66cdaa">
                    <span class="color-preview" id="positivePreview2"></span>
                </div>
                <div class="form-group">
                    <label>Neutral Renown Color (Start):</label>
                    <input type="color" id="neutralColor1" value="#4682b4">
                    <span class="color-preview" id="neutralPreview1"></span>
                </div>
                <div class="form-group">
                    <label>Neutral Renown Color (End):</label>
                    <input type="color" id="neutralColor2" value="#87cefa">
                    <span class="color-preview" id="neutralPreview2"></span>
                </div>
                <div class="form-group">
                    <label>Negative Renown Color (Start):</label>
                    <input type="color" id="negativeColor1" value="#b22222">
                    <span class="color-preview" id="negativePreview1"></span>
                </div>
                <div class="form-group">
                    <label>Negative Renown Color (End):</label>
                    <input type="color" id="negativeColor2" value="#dc143c">
                    <span class="color-preview" id="negativePreview2"></span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Factions & Cities</h2>
            <div id="factionsList"></div>
            <button onclick="addFaction()">+ Add Faction/City</button>
        </div>

        <div class="section">
            <h2>Relationships</h2>
            <div id="relationshipsList"></div>
        </div>

        <div class="actions">
            <button class="success" onclick="saveWorld()">Save World Configuration</button>
            <button onclick="exportWorld()">Export World to JSON</button>
            <button onclick="importWorld()">Import World from JSON</button>
            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleWorldImport(event)">
            <button class="danger" onclick="loadDefaultWorld()">Load Default World</button>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestionsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSuggestionsModal()">&times;</span>
            <h2 id="modalTitle">Bonus Suggestions</h2>
            <div id="suggestionsContent"></div>
        </div>
    </div>

    <script>
        let worldData = {
            worldName: "Default World",
            theme: {
                fontFamily: "'IM Fell English SC', serif",
                bgColor1: "#2e1a14",
                bgColor2: "#4a3326",
                textColor: "#f8e8c0",
                headingColor: "#ffdd8b",
                tableBg: "rgba(255, 248, 228, 0.9)",
                tableBorder: "#523c23",
                positiveColor1: "#2e8b57",
                positiveColor2: "#66cdaa",
                neutralColor1: "#4682b4",
                neutralColor2: "#87cefa",
                negativeColor1: "#b22222",
                negativeColor2: "#dc143c"
            },
            factions: [],
            relationships: {}
        };

        // Load world data from localStorage or use default
        function loadWorldData() {
            const saved = localStorage.getItem("worldData");
            if (saved) {
                try {
                    worldData = JSON.parse(saved);
                } catch (e) {
                    console.error("Error loading world data:", e);
                }
            } else {
                loadDefaultWorld();
            }
            renderAll();
        }

        function loadDefaultWorld() {
            worldData = {
                worldName: "Default World",
                theme: {
                    fontFamily: "'IM Fell English SC', serif",
                    bgColor1: "#2e1a14",
                    bgColor2: "#4a3326",
                    textColor: "#f8e8c0",
                    headingColor: "#ffdd8b",
                    tableBg: "rgba(255, 248, 228, 0.9)",
                    tableBorder: "#523c23",
                    positiveColor1: "#2e8b57",
                    positiveColor2: "#66cdaa",
                    neutralColor1: "#4682b4",
                    neutralColor2: "#87cefa",
                    negativeColor1: "#b22222",
                    negativeColor2: "#dc143c"
                },
                factions: [
                    { name: "Horizon Guard", bonuses: {
                        "-100": "Full bounty issued; attacked on sight.",
                        "-80": "Guard pursues the party aggressively.",
                        "-60": "Docking privileges denied.",
                        "-40": "Frequent inspections delay travel.",
                        "-20": "Guard is suspicious and unfriendly.",
                        "0": "Neutral stance; standard naval behavior.",
                        "20": "Minor supplies provided for free.",
                        "40": "Discounted repairs (50%) at Guard docks.",
                        "60": "Access to naval intelligence.",
                        "80": "Free ship upgrades.",
                        "100": "Full naval support in conflicts."
                    }},
                    { name: "Abyssal Blades", bonuses: {
                        "-100": "Fleet relentlessly hunts the party.",
                        "-80": "Bounty issued; pirates target the party.",
                        "-60": "Frequent pirate ambushes.",
                        "-40": "Pirates demand gold or tribute.",
                        "-20": "Increased chance of pirate encounters.",
                        "0": "Neutral stance; pirates may ignore the party.",
                        "20": "Discounts on smuggled goods (20%).",
                        "40": "Safe passage in pirate-controlled areas.",
                        "60": "Black-market goods provided at no cost.",
                        "80": "Free crew recruitment.",
                        "100": "Full pirate fleet support."
                    }},
                    { name: "Azure Syndicate", bonuses: {
                        "-100": "Syndicate sabotages the party's plans.",
                        "-80": "Trade routes blocked.",
                        "-60": "Merchants refuse to trade.",
                        "-40": "False rumors spread about the party.",
                        "-20": "Minor overcharging on goods/services.",
                        "0": "Neutral stance; standard trade behavior.",
                        "20": "Access to black-market auctions.",
                        "40": "Discounts on rare items (50%).",
                        "60": "Syndicate brokers alliances for the party.",
                        "80": "Reveals hidden relic locations.",
                        "100": "Free access to rare treasures."
                    }},
                    { name: "Gilded Corsairs", bonuses: {
                        "-100": "Full-scale Corsair fleet hunts you as a threat.",
                        "-80": "Corsair captains conspire to sink your ship.",
                        "-60": "Corsairs issue fines or bribes to naval authorities.",
                        "-40": "Corsairs sabotage your reputation.",
                        "-20": "Corsairs extort gold from you at ports.",
                        "0": "Neutral stance; they treat you with distant politeness.",
                        "20": "Discounts on luxury goods and repairs (25%).",
                        "40": "Safe passage through Corsair waters.",
                        "60": "Lavish gifts provided.",
                        "80": "Invitation to exclusive Corsair galas.",
                        "100": "Access to a treasure vault filled with rare magic items."
                    }},
                    { name: "Bloody Tide", bonuses: {
                        "-100": "Bloody Tide wages a bloody vendetta against you.",
                        "-80": "Bloody Tide sets fire to ports you visit.",
                        "-60": "Threatening warnings (bloody flags) left wherever you dock.",
                        "-40": "Bloody Tide ambushes your allies or crew.",
                        "-20": "Bloody Tide raiders target your ship for loot.",
                        "0": "Neutral stance; Bloody Tide won't bother you unless provoked.",
                        "20": "Discounts on black-market weapons (20%).",
                        "40": "Bloody Tide ships avoid attacking you.",
                        "60": "Tribute from captured villages is shared with you.",
                        "80": "Bloody Tide allies join you in raids.",
                        "100": "Declared Butcher of the Seas."
                    }},
                    { name: "Ebon Oath", bonuses: {
                        "-100": "Sea monsters hunt you relentlessly.",
                        "-80": "The cult declares you an enemy.",
                        "-60": "Ebon Oath zealots attack in coordinated ambushes.",
                        "-40": "Dark rituals disrupt your supplies.",
                        "-20": "Cultists spread unsettling rumors.",
                        "0": "Neutral stance; the cult observes you.",
                        "20": "Zealots provide intelligence.",
                        "40": "Safe haven in Ebon sanctuaries.",
                        "60": "Access to Ebon Oath rituals.",
                        "80": "Zealots sacrifice to complete your goals.",
                        "100": "Initiated into Ebon Oath leadership."
                    }},
                    { name: "Shadowfang Fleet", bonuses: {
                        "-100": "Fleet declares you a target for elimination.",
                        "-80": "Spies infiltrate your crew.",
                        "-60": "Fleet ships ambush you.",
                        "-40": "Shadowfang captains set traps.",
                        "-20": "Fleet agents monitor your ship's movements.",
                        "0": "Neutral stance; the fleet watches silently.",
                        "20": "Discounts on stealth-related magic items (20%).",
                        "40": "Shadowfang spies provide intelligence.",
                        "60": "Access to shadow-enhanced gear.",
                        "80": "Secret routes revealed.",
                        "100": "Fleet provides assassination or espionage services."
                    }},
                    { name: "Driftwood Marauders", bonuses: {
                        "-100": "Marauders dismantle your ship.",
                        "-80": "Marauders spread false rumors.",
                        "-60": "Driftwood ships ambush you to steal supplies.",
                        "-40": "Scavengers strip your ship of valuable parts.",
                        "-20": "Marauders sabotage your repairs.",
                        "0": "Neutral stance; they ignore you.",
                        "20": "Repairs and upgrades cost 20% less.",
                        "40": "Docking at Driftwood outposts allowed.",
                        "60": "Access to unique scavenged items.",
                        "80": "Free access to improvised magic gear.",
                        "100": "Driftwood Marauders repair your ship for free."
                    }},
                    { name: "Siren's Grasp", bonuses: {
                        "-100": "Leaders target you with illusions.",
                        "-80": "Allies turned against you by sirens.",
                        "-60": "Navigation obscured by illusion magic.",
                        "-40": "Ambushes by enchanted ships.",
                        "-20": "Sirens attempt to manipulate you.",
                        "0": "Neutral stance; they observe silently.",
                        "20": "Discounts on illusion-related magic items.",
                        "40": "Safe passage allowed.",
                        "60": "Invitations to hidden sanctuaries.",
                        "80": "Enchanters weave protective spells.",
                        "100": "Access to their powerful enchantments."
                    }},
                    { name: "Thunderclaw Reavers", bonuses: {
                        "-100": "Full fleet hunts you.",
                        "-80": "Declare your ship an enemy.",
                        "-60": "Intercept your trade routes.",
                        "-40": "Raid your ship for supplies.",
                        "-20": "Challenge you to duels at port.",
                        "0": "Neutral stance; respect but no alliance.",
                        "20": "Discounts on weapons and supplies.",
                        "40": "Safe passage through waters.",
                        "60": "Reavers provide protection.",
                        "80": "Access to crafted weapons.",
                        "100": "Full fleet fights alongside you."
                    }},
                    { name: "Frostfang Raiders", bonuses: {
                        "-100": "Full fleet wages war on you.",
                        "-80": "Shamans destroy your sails with storm magic.",
                        "-60": "Ambushes on frozen coasts.",
                        "-40": "Raiders freeze your supplies.",
                        "-20": "Shamans summon storms to delay you.",
                        "0": "Neutral stance; they ignore you.",
                        "20": "Discounts on cold-related items.",
                        "40": "Weather protection provided.",
                        "60": "Access to enchanted ice-forged weapons.",
                        "80": "Raiders fight alongside you.",
                        "100": "Shamans teach you storm magic."
                    }},
                    { name: "City: Olivara", bonuses: {
                        "-100": "City bars the party entry.",
                        "-80": "Residents alert hostile factions.",
                        "-60": "Guides and merchants refuse service.",
                        "-40": "Merchants overcharge (50% increase).",
                        "-20": "Locals distrust the party.",
                        "0": "Neutral stance; standard services.",
                        "20": "Reduced cost for guides and maps.",
                        "40": "Discounts on jungle tools.",
                        "60": "Free jungle guides and equipment.",
                        "80": "Rangers escort the party.",
                        "100": "Free lodging and supplies."
                    }},
                    { name: "City: Azurin", bonuses: {
                        "-100": "Pirates attack on sight.",
                        "-80": "Residents refuse aid.",
                        "-60": "Local pirates sabotage the party.",
                        "-40": "Merchants overcharge.",
                        "-20": "Locals distrust the party.",
                        "0": "Neutral pirate city behavior.",
                        "20": "Minor discounts in pirate markets.",
                        "40": "Reduced prices on black-market goods.",
                        "60": "Access to safe harbors.",
                        "80": "Free ship upgrades.",
                        "100": "Pirates rally to defend the party."
                    }},
                    { name: "City: Quintara", bonuses: {
                        "-100": "City bans the party from markets.",
                        "-80": "Merchants block trade routes.",
                        "-60": "Merchants spread false rumors.",
                        "-40": "Goods cost 50% more.",
                        "-20": "Merchants are wary.",
                        "0": "Neutral stance; standard trade.",
                        "20": "Merchant guilds share trade info.",
                        "40": "Access to exclusive markets.",
                        "60": "Rare goods available.",
                        "80": "Merchants prioritize your trades.",
                        "100": "Free trade permits granted."
                    }},
                    { name: "City: Halcyona", bonuses: {
                        "-100": "Declared heretics; full ban from city.",
                        "-80": "Residents refuse to interact.",
                        "-60": "City officials block access.",
                        "-40": "Merchants and priests overcharge.",
                        "-20": "Locals are suspicious.",
                        "0": "Neutral stance.",
                        "20": "Access to festivals and blessings.",
                        "40": "Discounts on magical rituals.",
                        "60": "Free divine blessings.",
                        "80": "Priests grant rare relics.",
                        "100": "Full divine support for the party."
                    }},
                    { name: "City: Tritonus", bonuses: {
                        "-100": "City bans the party from docks.",
                        "-80": "Engineers sabotage the party's ship.",
                        "-60": "Merchants overcharge for repairs.",
                        "-40": "Ship repairs delayed.",
                        "-20": "Shipbuilders are uncooperative.",
                        "0": "Neutral stance.",
                        "20": "Minor discounts on repairs.",
                        "40": "Discounts on advanced upgrades.",
                        "60": "Access to innovative ship prototypes.",
                        "80": "Priority access to prototypes.",
                        "100": "Free advanced maritime technology."
                    }}
                ],
                relationships: {
                    "Horizon Guard": {
                        friends: [],
                        enemies: ["Abyssal Blades", "Azure Syndicate", "Pirates"]
                    },
                    "Abyssal Blades": {
                        friends: ["Ebon Oath"],
                        enemies: ["Horizon Guard", "Azure Syndicate"]
                    },
                    "Azure Syndicate": {
                        friends: ["Gilded Corsairs"],
                        enemies: ["Bloody Tide", "Horizon Guard"]
                    },
                    "Gilded Corsairs": {
                        friends: ["Azure Syndicate"],
                        enemies: ["Bloody Tide", "Driftwood Marauders"]
                    },
                    "Bloody Tide": {
                        friends: [],
                        enemies: ["Everyone"]
                    },
                    "Ebon Oath": {
                        friends: ["Abyssal Blades"],
                        enemies: ["Halcyona", "Horizon Guard"]
                    },
                    "Shadowfang Fleet": {
                        friends: ["Ebon Oath"],
                        enemies: ["Thunderclaw Reavers"]
                    },
                    "Driftwood Marauders": {
                        friends: ["Thunderclaw Reavers"],
                        enemies: ["Gilded Corsairs"]
                    },
                    "Siren's Grasp": {
                        friends: ["Azure Syndicate"],
                        enemies: ["Frostfang Raiders"]
                    },
                    "Thunderclaw Reavers": {
                        friends: ["Driftwood Marauders"],
                        enemies: ["Shadowfang Fleet", "Bloody Tide"]
                    },
                    "Frostfang Raiders": {
                        friends: [],
                        enemies: ["Siren's Grasp", "Horizon Guard"]
                    },
                    "City: Olivara": {
                        friends: ["Horizon Guard"],
                        enemies: ["Bloody Tide"]
                    },
                    "City: Azurin": {
                        friends: ["Pirates"],
                        enemies: ["Horizon Guard"]
                    },
                    "City: Quintara": {
                        friends: ["Horizon Guard", "Azure Syndicate"],
                        enemies: ["Abyssal Blades"]
                    },
                    "City: Halcyona": {
                        friends: ["Horizon Guard", "Halcyona Scholars"],
                        enemies: ["Ebon Oath"]
                    },
                    "City: Tritonus": {
                        friends: ["Horizon Guard", "Azure Syndicate"],
                        enemies: ["Bloody Tide"]
                    }
                }
            };
            renderAll();
            showMessage("Default world loaded", "success");
        }

        function renderAll() {
            document.getElementById("worldName").value = worldData.worldName || "";
            document.getElementById("fontFamily").value = worldData.theme.fontFamily;
            document.getElementById("bgColor1").value = worldData.theme.bgColor1;
            document.getElementById("bgColor2").value = worldData.theme.bgColor2;
            document.getElementById("textColor").value = worldData.theme.textColor;
            document.getElementById("headingColor").value = worldData.theme.headingColor;
            // Extract RGB from rgba format for color picker
            let tableBgValue = "#fff8e4";
            if (worldData.theme.tableBg) {
                const rgbaMatch = worldData.theme.tableBg.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (rgbaMatch) {
                    const r = parseInt(rgbaMatch[1]).toString(16).padStart(2, '0');
                    const g = parseInt(rgbaMatch[2]).toString(16).padStart(2, '0');
                    const b = parseInt(rgbaMatch[3]).toString(16).padStart(2, '0');
                    tableBgValue = `#${r}${g}${b}`;
                } else if (worldData.theme.tableBg.startsWith('#')) {
                    tableBgValue = worldData.theme.tableBg;
                }
            }
            document.getElementById("tableBg").value = tableBgValue;
            document.getElementById("tableBorder").value = worldData.theme.tableBorder;
            document.getElementById("positiveColor1").value = worldData.theme.positiveColor1;
            document.getElementById("positiveColor2").value = worldData.theme.positiveColor2;
            document.getElementById("neutralColor1").value = worldData.theme.neutralColor1;
            document.getElementById("neutralColor2").value = worldData.theme.neutralColor2;
            document.getElementById("negativeColor1").value = worldData.theme.negativeColor1;
            document.getElementById("negativeColor2").value = worldData.theme.negativeColor2;
            
            updateColorPreviews();
            renderFactions();
            renderRelationships();
        }

        function updateColorPreviews() {
            document.getElementById("bgPreview1").style.backgroundColor = document.getElementById("bgColor1").value;
            document.getElementById("bgPreview2").style.backgroundColor = document.getElementById("bgColor2").value;
            document.getElementById("textPreview").style.backgroundColor = document.getElementById("textColor").value;
            document.getElementById("headingPreview").style.backgroundColor = document.getElementById("headingColor").value;
            document.getElementById("tableBgPreview").style.backgroundColor = document.getElementById("tableBg").value;
            document.getElementById("tableBorderPreview").style.backgroundColor = document.getElementById("tableBorder").value;
            document.getElementById("positivePreview1").style.backgroundColor = document.getElementById("positiveColor1").value;
            document.getElementById("positivePreview2").style.backgroundColor = document.getElementById("positiveColor2").value;
            document.getElementById("neutralPreview1").style.backgroundColor = document.getElementById("neutralColor1").value;
            document.getElementById("neutralPreview2").style.backgroundColor = document.getElementById("neutralColor2").value;
            document.getElementById("negativePreview1").style.backgroundColor = document.getElementById("negativeColor1").value;
            document.getElementById("negativePreview2").style.backgroundColor = document.getElementById("negativeColor2").value;
        }

        // Add event listeners for color previews
        ['bgColor1', 'bgColor2', 'textColor', 'headingColor', 'tableBg', 'tableBorder', 
         'positiveColor1', 'positiveColor2', 'neutralColor1', 'neutralColor2', 
         'negativeColor1', 'negativeColor2'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateColorPreviews);
        });

        function renderFactions() {
            const container = document.getElementById("factionsList");
            container.innerHTML = "";
            
            worldData.factions.forEach((faction, index) => {
                const div = document.createElement("div");
                div.className = "faction-item";
                div.innerHTML = `
                    <div class="faction-header">
                        <h3>${faction.name}</h3>
                        <button class="danger" onclick="removeFaction(${index})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" value="${faction.name}" onchange="updateFactionName(${index}, this.value)">
                    </div>
                    <div class="form-group">
                        <label>Faction/City Type & Descriptors:</label>
                        <div class="descriptor-selector">
                            <select id="descriptor-select-${index}" onchange="addDescriptor(${index}, this.value)">
                                <option value="">-- Select a descriptor to add --</option>
                            </select>
                            <button onclick="generateSuggestions(${index})">✨ Generate Bonus Suggestions</button>
                        </div>
                        <div class="selected-descriptors" id="selected-descriptors-${index}"></div>
                    </div>
                    <div class="form-group">
                        <label>Bonuses/Penalties:</label>
                        <div id="bonuses-${index}"></div>
                        <button onclick="addBonus(${index})">+ Add Bonus/Penalty</button>
                    </div>
                `;
                container.appendChild(div);
                
                // Render descriptors
                renderDescriptors(index, faction);
                
                // Render bonuses
                const bonusesContainer = document.getElementById(`bonuses-${index}`);
                Object.keys(faction.bonuses).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
                    const bonusDiv = document.createElement("div");
                    bonusDiv.className = "bonus-entry";
                    bonusDiv.innerHTML = `
                        <input type="number" value="${level}" placeholder="Renown Level" onchange="updateBonusLevel(${index}, '${level}', this.value)">
                        <textarea placeholder="Description" onchange="updateBonusText(${index}, '${level}', this.value)">${faction.bonuses[level]}</textarea>
                        <button class="danger" onclick="removeBonus(${index}, '${level}')">Remove</button>
                    `;
                    bonusesContainer.appendChild(bonusDiv);
                });
            });
        }

        const availableDescriptors = [
            "Pirate", "Naval", "Merchant", "Religious", "Criminal", "Military", 
            "Magical", "Noble", "Cult", "City", "Trading", "Warrior", "Scholar",
            "Assassin", "Thief", "Mercenary", "Explorer", "Diplomat", "Artisan",
            "Mystical", "Ancient", "Corrupt", "Lawful", "Chaotic", "Neutral"
        ];

        function renderDescriptors(index, faction) {
            if (!faction.descriptors) {
                faction.descriptors = [];
            }
            
            // Populate dropdown with available descriptors (excluding already selected ones)
            const select = document.getElementById(`descriptor-select-${index}`);
            select.innerHTML = '<option value="">-- Select a descriptor to add --</option>';
            availableDescriptors.forEach(desc => {
                if (!faction.descriptors.includes(desc)) {
                    const option = document.createElement("option");
                    option.value = desc;
                    option.textContent = desc;
                    select.appendChild(option);
                }
            });
            
            // Render selected descriptors with remove buttons
            const container = document.getElementById(`selected-descriptors-${index}`);
            container.innerHTML = "";
            faction.descriptors.forEach(desc => {
                const tag = document.createElement("div");
                tag.className = "descriptor-tag";
                tag.innerHTML = `
                    <span>${desc}</span>
                    <button class="remove-btn" onclick="removeDescriptor(${index}, '${desc}')" title="Remove ${desc}">×</button>
                `;
                container.appendChild(tag);
            });
        }

        function addDescriptor(index, descriptor) {
            if (!descriptor || descriptor === "") return;
            
            if (!worldData.factions[index].descriptors) {
                worldData.factions[index].descriptors = [];
            }
            
            if (!worldData.factions[index].descriptors.includes(descriptor)) {
                worldData.factions[index].descriptors.push(descriptor);
                renderDescriptors(index, worldData.factions[index]);
            }
            
            // Reset dropdown
            document.getElementById(`descriptor-select-${index}`).value = "";
        }

        function removeDescriptor(index, descriptor) {
            if (!worldData.factions[index].descriptors) {
                worldData.factions[index].descriptors = [];
            }
            
            worldData.factions[index].descriptors = worldData.factions[index].descriptors.filter(d => d !== descriptor);
            renderDescriptors(index, worldData.factions[index]);
        }

        function addFaction() {
            worldData.factions.push({
                name: "New Faction",
                bonuses: { "0": "Neutral stance." },
                descriptors: []
            });
            if (!worldData.relationships["New Faction"]) {
                worldData.relationships["New Faction"] = { friends: [], enemies: [] };
            }
            renderFactions();
            renderRelationships();
        }

        function removeFaction(index) {
            const faction = worldData.factions[index];
            delete worldData.relationships[faction.name];
            worldData.factions.splice(index, 1);
            renderFactions();
            renderRelationships();
        }

        function updateFactionName(index, newName) {
            const oldName = worldData.factions[index].name;
            worldData.factions[index].name = newName;
            if (worldData.relationships[oldName]) {
                worldData.relationships[newName] = worldData.relationships[oldName];
                delete worldData.relationships[oldName];
            } else {
                worldData.relationships[newName] = { friends: [], enemies: [] };
            }
            renderFactions();
            renderRelationships();
        }

        function addBonus(factionIndex) {
            const level = prompt("Enter renown level (e.g., -100, 0, 100):");
            if (level !== null && level !== "") {
                worldData.factions[factionIndex].bonuses[level] = "";
                renderFactions();
            }
        }

        function updateBonusLevel(factionIndex, oldLevel, newLevel) {
            const faction = worldData.factions[factionIndex];
            if (oldLevel !== newLevel && newLevel !== "") {
                faction.bonuses[newLevel] = faction.bonuses[oldLevel] || "";
                delete faction.bonuses[oldLevel];
                renderFactions();
            }
        }

        function updateBonusText(factionIndex, level, text) {
            worldData.factions[factionIndex].bonuses[level] = text;
        }

        function removeBonus(factionIndex, level) {
            delete worldData.factions[factionIndex].bonuses[level];
            renderFactions();
        }

        function renderRelationships() {
            const container = document.getElementById("relationshipsList");
            container.innerHTML = "";
            
            worldData.factions.forEach(faction => {
                if (!worldData.relationships[faction.name]) {
                    worldData.relationships[faction.name] = { friends: [], enemies: [] };
                }
                
                const div = document.createElement("div");
                div.className = "faction-item";
                div.innerHTML = `
                    <h3>${faction.name}</h3>
                    <div class="form-group">
                        <label>Friends:</label>
                        <div id="friends-${faction.name}"></div>
                        <button onclick="addRelationship('${faction.name}', 'friends')">+ Add Friend</button>
                    </div>
                    <div class="form-group">
                        <label>Enemies:</label>
                        <div id="enemies-${faction.name}"></div>
                        <button onclick="addRelationship('${faction.name}', 'enemies')">+ Add Enemy</button>
                    </div>
                `;
                container.appendChild(div);
                
                // Render friends
                const friendsContainer = document.getElementById(`friends-${faction.name}`);
                worldData.relationships[faction.name].friends.forEach((friend, idx) => {
                    const relDiv = document.createElement("div");
                    relDiv.className = "relationship-entry";
                    relDiv.innerHTML = `
                        <select onchange="updateRelationship('${faction.name}', 'friends', ${idx}, this.value)">
                            ${worldData.factions.map(f => `<option value="${f.name}" ${f.name === friend ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                        <button class="danger" onclick="removeRelationship('${faction.name}', 'friends', ${idx})">Remove</button>
                    `;
                    friendsContainer.appendChild(relDiv);
                });
                
                // Render enemies
                const enemiesContainer = document.getElementById(`enemies-${faction.name}`);
                worldData.relationships[faction.name].enemies.forEach((enemy, idx) => {
                    const relDiv = document.createElement("div");
                    relDiv.className = "relationship-entry";
                    relDiv.innerHTML = `
                        <select onchange="updateRelationship('${faction.name}', 'enemies', ${idx}, this.value)">
                            ${worldData.factions.map(f => `<option value="${f.name}" ${f.name === enemy ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                        <button class="danger" onclick="removeRelationship('${faction.name}', 'enemies', ${idx})">Remove</button>
                    `;
                    enemiesContainer.appendChild(relDiv);
                });
            });
        }

        function addRelationship(factionName, type) {
            if (!worldData.relationships[factionName][type]) {
                worldData.relationships[factionName][type] = [];
            }
            const availableFactions = worldData.factions.filter(f => f.name !== factionName).map(f => f.name);
            if (availableFactions.length === 0) {
                alert("No other factions available to add as relationship.");
                return;
            }
            worldData.relationships[factionName][type].push(availableFactions[0]);
            renderRelationships();
        }

        function updateRelationship(factionName, type, index, newValue) {
            worldData.relationships[factionName][type][index] = newValue;
        }

        function removeRelationship(factionName, type, index) {
            worldData.relationships[factionName][type].splice(index, 1);
            renderRelationships();
        }

        function saveWorld() {
            // Update world data from form
            worldData.worldName = document.getElementById("worldName").value || "Unnamed World";
            worldData.theme.fontFamily = document.getElementById("fontFamily").value;
            worldData.theme.bgColor1 = document.getElementById("bgColor1").value;
            worldData.theme.bgColor2 = document.getElementById("bgColor2").value;
            worldData.theme.textColor = document.getElementById("textColor").value;
            worldData.theme.headingColor = document.getElementById("headingColor").value;
            const tableBgRgb = hexToRgba(document.getElementById("tableBg").value, 0.9);
            worldData.theme.tableBg = tableBgRgb;
            worldData.theme.tableBorder = document.getElementById("tableBorder").value;
            worldData.theme.positiveColor1 = document.getElementById("positiveColor1").value;
            worldData.theme.positiveColor2 = document.getElementById("positiveColor2").value;
            worldData.theme.neutralColor1 = document.getElementById("neutralColor1").value;
            worldData.theme.neutralColor2 = document.getElementById("neutralColor2").value;
            worldData.theme.negativeColor1 = document.getElementById("negativeColor1").value;
            worldData.theme.negativeColor2 = document.getElementById("negativeColor2").value;
            
            localStorage.setItem("worldData", JSON.stringify(worldData));
            showMessage("World configuration saved!", "success");
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function exportWorld() {
            saveWorld(); // Save current state first
            const dataStr = JSON.stringify(worldData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${worldData.worldName.replace(/[^a-z0-9]/gi, '_')}_world.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage("World exported successfully!", "success");
        }

        function importWorld() {
            document.getElementById("importFile").click();
        }

        function handleWorldImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.factions && imported.theme && imported.relationships) {
                        worldData = imported;
                        renderAll();
                        saveWorld();
                        showMessage("World imported successfully!", "success");
                    } else {
                        showMessage("Invalid world file format.", "error");
                    }
                } catch (error) {
                    showMessage("Failed to import: " + error.message, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ""; // Reset file input
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById("message");
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            setTimeout(() => {
                msgDiv.textContent = "";
                msgDiv.className = "";
            }, 3000);
        }

        // Suggestion generation
        const suggestionTemplates = {
            "Pirate": {
                negative: [
                    { level: -100, text: "Pirate fleet relentlessly hunts the party." },
                    { level: -80, text: "Bounty issued; pirates target the party." },
                    { level: -60, text: "Frequent pirate ambushes." },
                    { level: -40, text: "Pirates demand gold or tribute." },
                    { level: -20, text: "Increased chance of pirate encounters." }
                ],
                positive: [
                    { level: 20, text: "Discounts on smuggled goods (20%)." },
                    { level: 40, text: "Safe passage in pirate-controlled areas." },
                    { level: 60, text: "Black-market goods provided at no cost." },
                    { level: 80, text: "Free crew recruitment." },
                    { level: 100, text: "Full pirate fleet support." }
                ]
            },
            "Naval": {
                negative: [
                    { level: -100, text: "Full bounty issued; attacked on sight." },
                    { level: -80, text: "Naval forces pursue the party aggressively." },
                    { level: -60, text: "Docking privileges denied." },
                    { level: -40, text: "Frequent inspections delay travel." },
                    { level: -20, text: "Naval forces are suspicious and unfriendly." }
                ],
                positive: [
                    { level: 20, text: "Minor supplies provided for free." },
                    { level: 40, text: "Discounted repairs (50%) at naval docks." },
                    { level: 60, text: "Access to naval intelligence." },
                    { level: 80, text: "Free ship upgrades." },
                    { level: 100, text: "Full naval support in conflicts." }
                ]
            },
            "Merchant": {
                negative: [
                    { level: -100, text: "Merchants sabotage the party's plans." },
                    { level: -80, text: "Trade routes blocked." },
                    { level: -60, text: "Merchants refuse to trade." },
                    { level: -40, text: "False rumors spread about the party." },
                    { level: -20, text: "Minor overcharging on goods/services." }
                ],
                positive: [
                    { level: 20, text: "Access to exclusive auctions." },
                    { level: 40, text: "Discounts on rare items (50%)." },
                    { level: 60, text: "Merchants broker alliances for the party." },
                    { level: 80, text: "Reveals hidden relic locations." },
                    { level: 100, text: "Free access to rare treasures." }
                ]
            },
            "Religious": {
                negative: [
                    { level: -100, text: "Declared heretics; full ban from area." },
                    { level: -80, text: "Religious authorities refuse to interact." },
                    { level: -60, text: "Temples block access." },
                    { level: -40, text: "Priests and merchants overcharge." },
                    { level: -20, text: "Locals are suspicious." }
                ],
                positive: [
                    { level: 20, text: "Access to festivals and blessings." },
                    { level: 40, text: "Discounts on magical rituals." },
                    { level: 60, text: "Free divine blessings." },
                    { level: 80, text: "Priests grant rare relics." },
                    { level: 100, text: "Full divine support for the party." }
                ]
            },
            "Criminal": {
                negative: [
                    { level: -100, text: "Criminal organization targets you for elimination." },
                    { level: -80, text: "Spies infiltrate your crew." },
                    { level: -60, text: "Criminal ambushes." },
                    { level: -40, text: "Criminals set traps." },
                    { level: -20, text: "Criminal agents monitor your movements." }
                ],
                positive: [
                    { level: 20, text: "Discounts on illegal goods (20%)." },
                    { level: 40, text: "Criminal contacts provide intelligence." },
                    { level: 60, text: "Access to criminal networks." },
                    { level: 80, text: "Secret routes revealed." },
                    { level: 100, text: "Criminal organization provides services." }
                ]
            },
            "Military": {
                negative: [
                    { level: -100, text: "Military declares you an enemy." },
                    { level: -80, text: "Military forces hunt you." },
                    { level: -60, text: "Military blocks your access." },
                    { level: -40, text: "Military inspections delay you." },
                    { level: -20, text: "Military is wary of you." }
                ],
                positive: [
                    { level: 20, text: "Minor military supplies provided." },
                    { level: 40, text: "Discounted military equipment." },
                    { level: 60, text: "Access to military intelligence." },
                    { level: 80, text: "Military provides protection." },
                    { level: 100, text: "Full military support in conflicts." }
                ]
            },
            "Magical": {
                negative: [
                    { level: -100, text: "Mages target you with powerful spells." },
                    { level: -80, text: "Allies turned against you by magic." },
                    { level: -60, text: "Navigation obscured by illusion magic." },
                    { level: -40, text: "Ambushes by enchanted forces." },
                    { level: -20, text: "Mages attempt to manipulate you." }
                ],
                positive: [
                    { level: 20, text: "Discounts on magic items." },
                    { level: 40, text: "Safe passage allowed." },
                    { level: 60, text: "Invitations to hidden sanctuaries." },
                    { level: 80, text: "Mages weave protective spells." },
                    { level: 100, text: "Access to powerful enchantments." }
                ]
            },
            "City": {
                negative: [
                    { level: -100, text: "City bars the party entry." },
                    { level: -80, text: "Residents alert hostile factions." },
                    { level: -60, text: "Guides and merchants refuse service." },
                    { level: -40, text: "Merchants overcharge (50% increase)." },
                    { level: -20, text: "Locals distrust the party." }
                ],
                positive: [
                    { level: 20, text: "Reduced cost for guides and maps." },
                    { level: 40, text: "Discounts on local goods." },
                    { level: 60, text: "Free guides and equipment." },
                    { level: 80, text: "Local escorts provided." },
                    { level: 100, text: "Free lodging and supplies." }
                ]
            },
            "Noble": {
                negative: [
                    { level: -100, text: "Nobles declare you persona non grata." },
                    { level: -80, text: "Noble houses blacklist you from high society." },
                    { level: -60, text: "Nobles refuse to grant audiences." },
                    { level: -40, text: "Nobles spread rumors to damage your reputation." },
                    { level: -20, text: "Nobles treat you with cold disdain." }
                ],
                positive: [
                    { level: 20, text: "Minor noble favors granted." },
                    { level: 40, text: "Access to noble events and galas." },
                    { level: 60, text: "Nobles provide political support." },
                    { level: 80, text: "Noble houses offer alliances." },
                    { level: 100, text: "Granted noble title and full privileges." }
                ]
            },
            "Cult": {
                negative: [
                    { level: -100, text: "Cult declares you a heretic and enemy." },
                    { level: -80, text: "Cultists hunt you relentlessly." },
                    { level: -60, text: "Cultists perform dark rituals against you." },
                    { level: -40, text: "Cult spreads fear and suspicion about you." },
                    { level: -20, text: "Cultists watch you with suspicion." }
                ],
                positive: [
                    { level: 20, text: "Cultists provide minor information." },
                    { level: 40, text: "Access to cult sanctuaries." },
                    { level: 60, text: "Cultists perform rituals to aid you." },
                    { level: 80, text: "Initiated into cult secrets." },
                    { level: 100, text: "Elevated to cult leadership." }
                ]
            },
            "Trading": {
                negative: [
                    { level: -100, text: "Trading guilds ban you from all markets." },
                    { level: -80, text: "Merchants refuse all business with you." },
                    { level: -60, text: "Trade routes closed to you." },
                    { level: -40, text: "Merchants charge exorbitant prices." },
                    { level: -20, text: "Merchants are reluctant to deal." }
                ],
                positive: [
                    { level: 20, text: "Access to exclusive trading posts." },
                    { level: 40, text: "Discounts on trade goods (30%)." },
                    { level: 60, text: "Trading guilds share market intelligence." },
                    { level: 80, text: "Priority access to rare commodities." },
                    { level: 100, text: "Honorary membership in trading guilds." }
                ]
            },
            "Warrior": {
                negative: [
                    { level: -100, text: "Warriors declare you a sworn enemy." },
                    { level: -80, text: "Warrior bands hunt you for sport." },
                    { level: -60, text: "Warriors challenge you to deadly duels." },
                    { level: -40, text: "Warriors spread tales of your cowardice." },
                    { level: -20, text: "Warriors mock and belittle you." }
                ],
                positive: [
                    { level: 20, text: "Warriors respect your combat prowess." },
                    { level: 40, text: "Access to warrior training grounds." },
                    { level: 60, text: "Warriors offer to fight alongside you." },
                    { level: 80, text: "Access to legendary weapons and armor." },
                    { level: 100, text: "Declared champion and granted warrior title." }
                ]
            },
            "Scholar": {
                negative: [
                    { level: -100, text: "Scholars declare your research heretical." },
                    { level: -80, text: "Libraries and academies ban you." },
                    { level: -60, text: "Scholars refuse to share knowledge." },
                    { level: -40, text: "Scholars spread false information about you." },
                    { level: -20, text: "Scholars are dismissive of your questions." }
                ],
                positive: [
                    { level: 20, text: "Scholars share basic information." },
                    { level: 40, text: "Access to restricted libraries." },
                    { level: 60, text: "Scholars provide rare knowledge." },
                    { level: 80, text: "Invited to exclusive academic circles." },
                    { level: 100, text: "Granted access to ancient and forbidden texts." }
                ]
            },
            "Assassin": {
                negative: [
                    { level: -100, text: "Assassins place a contract on your life." },
                    { level: -80, text: "Assassins actively hunt you." },
                    { level: -60, text: "Assassins attempt to poison you." },
                    { level: -40, text: "Assassins sabotage your plans." },
                    { level: -20, text: "Assassins watch you from the shadows." }
                ],
                positive: [
                    { level: 20, text: "Assassins ignore you." },
                    { level: 40, text: "Assassins share basic intelligence." },
                    { level: 60, text: "Access to assassination services." },
                    { level: 80, text: "Assassins provide protection." },
                    { level: 100, text: "Honorary member of the assassins' guild." }
                ]
            },
            "Thief": {
                negative: [
                    { level: -100, text: "Thieves' guild marks you for death." },
                    { level: -80, text: "Thieves constantly rob you." },
                    { level: -60, text: "Thieves sabotage your equipment." },
                    { level: -40, text: "Thieves spread rumors about your wealth." },
                    { level: -20, text: "Thieves target you for pickpocketing." }
                ],
                positive: [
                    { level: 20, text: "Thieves leave you alone." },
                    { level: 40, text: "Thieves share information about targets." },
                    { level: 60, text: "Access to stolen goods markets." },
                    { level: 80, text: "Thieves provide lockpicking services." },
                    { level: 100, text: "Honorary member of the thieves' guild." }
                ]
            },
            "Mercenary": {
                negative: [
                    { level: -100, text: "Mercenaries are hired to eliminate you." },
                    { level: -80, text: "Mercenary companies hunt you." },
                    { level: -60, text: "Mercenaries refuse to work with you." },
                    { level: -40, text: "Mercenaries charge exorbitant rates." },
                    { level: -20, text: "Mercenaries are untrustworthy around you." }
                ],
                positive: [
                    { level: 20, text: "Mercenaries offer standard rates." },
                    { level: 40, text: "Discounts on mercenary services (25%)." },
                    { level: 60, text: "Mercenaries provide reliable protection." },
                    { level: 80, text: "Access to elite mercenary companies." },
                    { level: 100, text: "Mercenaries fight for you at no cost." }
                ]
            },
            "Explorer": {
                negative: [
                    { level: -100, text: "Explorers sabotage your expeditions." },
                    { level: -80, text: "Explorers refuse to share maps." },
                    { level: -60, text: "Explorers spread false information." },
                    { level: -40, text: "Explorers charge high prices for guides." },
                    { level: -20, text: "Explorers are reluctant to help." }
                ],
                positive: [
                    { level: 20, text: "Explorers share basic maps." },
                    { level: 40, text: "Access to detailed exploration reports." },
                    { level: 60, text: "Explorers guide you to hidden locations." },
                    { level: 80, text: "Access to secret routes and shortcuts." },
                    { level: 100, text: "Explorers share all discovered treasures." }
                ]
            },
            "Diplomat": {
                negative: [
                    { level: -100, text: "Diplomats work against you in all negotiations." },
                    { level: -80, text: "Diplomatic channels closed to you." },
                    { level: -60, text: "Diplomats spread negative propaganda." },
                    { level: -40, text: "Diplomats refuse to meet with you." },
                    { level: -20, text: "Diplomats are cold and unhelpful." }
                ],
                positive: [
                    { level: 20, text: "Diplomats provide basic introductions." },
                    { level: 40, text: "Access to diplomatic circles." },
                    { level: 60, text: "Diplomats broker important alliances." },
                    { level: 80, text: "Diplomatic immunity granted." },
                    { level: 100, text: "Honored as a master diplomat." }
                ]
            },
            "Artisan": {
                negative: [
                    { level: -100, text: "Artisans refuse to work for you." },
                    { level: -80, text: "Guilds blacklist you from services." },
                    { level: -60, text: "Artisans sabotage your orders." },
                    { level: -40, text: "Artisans charge triple prices." },
                    { level: -20, text: "Artisans are slow and uncooperative." }
                ],
                positive: [
                    { level: 20, text: "Artisans provide standard services." },
                    { level: 40, text: "Discounts on crafted items (30%)." },
                    { level: 60, text: "Access to master craftsmen." },
                    { level: 80, text: "Artisans create custom masterpieces." },
                    { level: 100, text: "Honorary guild member with free services." }
                ]
            },
            "Mystical": {
                negative: [
                    { level: -100, text: "Mystical forces curse you." },
                    { level: -80, text: "Mystical barriers block your path." },
                    { level: -60, text: "Mystical entities harass you." },
                    { level: -40, text: "Mystical visions mislead you." },
                    { level: -20, text: "Mystical energies feel hostile." }
                ],
                positive: [
                    { level: 20, text: "Mystical forces are neutral." },
                    { level: 40, text: "Mystical visions guide you." },
                    { level: 60, text: "Access to mystical sanctuaries." },
                    { level: 80, text: "Mystical entities aid you." },
                    { level: 100, text: "Blessed by mystical powers." }
                ]
            },
            "Ancient": {
                negative: [
                    { level: -100, text: "Ancient guardians hunt you." },
                    { level: -80, text: "Ancient ruins are sealed from you." },
                    { level: -60, text: "Ancient curses affect you." },
                    { level: -40, text: "Ancient knowledge is hidden from you." },
                    { level: -20, text: "Ancient sites feel unwelcoming." }
                ],
                positive: [
                    { level: 20, text: "Ancient sites allow basic access." },
                    { level: 40, text: "Ancient guardians provide guidance." },
                    { level: 60, text: "Access to ancient libraries." },
                    { level: 80, text: "Ancient secrets revealed to you." },
                    { level: 100, text: "Honored as keeper of ancient wisdom." }
                ]
            },
            "Corrupt": {
                negative: [
                    { level: -100, text: "Corrupt officials frame you for crimes." },
                    { level: -80, text: "Corrupt networks target you." },
                    { level: -60, text: "Corrupt officials demand bribes." },
                    { level: -40, text: "Corrupt systems work against you." },
                    { level: -20, text: "Corrupt officials are unhelpful." }
                ],
                positive: [
                    { level: 20, text: "Corrupt officials ignore you." },
                    { level: 40, text: "Corrupt networks provide information." },
                    { level: 60, text: "Access to corrupt networks." },
                    { level: 80, text: "Corrupt officials grant favors." },
                    { level: 100, text: "Integrated into corrupt power structure." }
                ]
            },
            "Lawful": {
                negative: [
                    { level: -100, text: "Lawful authorities declare you an outlaw." },
                    { level: -80, text: "Lawful forces hunt you." },
                    { level: -60, text: "Lawful officials deny you services." },
                    { level: -40, text: "Lawful authorities are suspicious." },
                    { level: -20, text: "Lawful officials are uncooperative." }
                ],
                positive: [
                    { level: 20, text: "Lawful authorities treat you fairly." },
                    { level: 40, text: "Access to lawful services and protection." },
                    { level: 60, text: "Lawful authorities provide support." },
                    { level: 80, text: "Granted legal privileges and immunities." },
                    { level: 100, text: "Honored as a champion of law and order." }
                ]
            },
            "Chaotic": {
                negative: [
                    { level: -100, text: "Chaotic forces actively work against you." },
                    { level: -80, text: "Chaotic agents sabotage your plans." },
                    { level: -60, text: "Chaotic forces create obstacles." },
                    { level: -40, text: "Chaotic agents spread disorder around you." },
                    { level: -20, text: "Chaotic forces are unpredictable." }
                ],
                positive: [
                    { level: 20, text: "Chaotic forces leave you alone." },
                    { level: 40, text: "Chaotic agents provide information." },
                    { level: 60, text: "Access to chaotic networks." },
                    { level: 80, text: "Chaotic forces aid your plans." },
                    { level: 100, text: "Embraced as an agent of chaos." }
                ]
            },
            "Neutral": {
                negative: [
                    { level: -100, text: "Neutral parties actively avoid you." },
                    { level: -80, text: "Neutral forces refuse to interact." },
                    { level: -60, text: "Neutral parties are unhelpful." },
                    { level: -40, text: "Neutral forces are indifferent." },
                    { level: -20, text: "Neutral parties are distant." }
                ],
                positive: [
                    { level: 20, text: "Neutral parties are friendly." },
                    { level: 40, text: "Neutral forces provide basic aid." },
                    { level: 60, text: "Neutral parties offer balanced support." },
                    { level: 80, text: "Neutral forces grant favors." },
                    { level: 100, text: "Respected as a balanced mediator." }
                ]
            }
        };

        function generateSuggestions(factionIndex) {
            const faction = worldData.factions[factionIndex];
            const descriptors = faction.descriptors || [];
            
            if (descriptors.length === 0) {
                alert("Please select at least one descriptor to generate suggestions.");
                return;
            }

            const suggestions = {};
            const allSuggestions = {}; // Collect all suggestions per level

            // Collect suggestions from all selected descriptors
            descriptors.forEach(desc => {
                const template = suggestionTemplates[desc];
                if (template) {
                    template.negative.forEach(item => {
                        if (!allSuggestions[item.level]) {
                            allSuggestions[item.level] = [];
                        }
                        allSuggestions[item.level].push(item.text);
                    });
                    template.positive.forEach(item => {
                        if (!allSuggestions[item.level]) {
                            allSuggestions[item.level] = [];
                        }
                        allSuggestions[item.level].push(item.text);
                    });
                }
            });

            // For each level, pick the best suggestion or combine them
            Object.keys(allSuggestions).forEach(level => {
                const levelSuggestions = allSuggestions[level];
                if (levelSuggestions.length === 1) {
                    suggestions[level] = levelSuggestions[0];
                } else {
                    // If multiple descriptors, prefer more specific ones or combine concepts
                    // For now, randomly pick one, but you could make this smarter
                    suggestions[level] = levelSuggestions[Math.floor(Math.random() * levelSuggestions.length)];
                }
            });

            // Add neutral suggestion if missing
            if (!suggestions[0]) {
                const neutralTexts = [
                    "Neutral stance; standard behavior.",
                    "Neutral stance; they observe you.",
                    "Neutral stance; no special treatment.",
                    "Neutral stance; standard services."
                ];
                suggestions[0] = neutralTexts[Math.floor(Math.random() * neutralTexts.length)];
            }

            // Ensure we have suggestions for all standard levels
            const standardLevels = [-100, -80, -60, -40, -20, 0, 20, 40, 60, 80, 100];
            standardLevels.forEach(level => {
                if (!suggestions[level]) {
                    // Generate a generic suggestion based on descriptors
                    const isNegative = level < 0;
                    const isCity = descriptors.includes("City");
                    const isPirate = descriptors.includes("Pirate");
                    const isMerchant = descriptors.includes("Merchant");
                    const isReligious = descriptors.includes("Religious");
                    
                    if (isNegative) {
                        if (isCity) {
                            suggestions[level] = `City residents become increasingly hostile.`;
                        } else if (isPirate) {
                            suggestions[level] = `Pirates target the party more frequently.`;
                        } else if (isMerchant) {
                            suggestions[level] = `Merchants refuse to deal with the party.`;
                        } else {
                            suggestions[level] = `The faction becomes increasingly hostile.`;
                        }
                    } else if (level > 0) {
                        if (isCity) {
                            suggestions[level] = `City provides better services and discounts.`;
                        } else if (isPirate) {
                            suggestions[level] = `Pirates offer better deals and safe passage.`;
                        } else if (isMerchant) {
                            suggestions[level] = `Merchants offer exclusive deals and rare goods.`;
                        } else if (isReligious) {
                            suggestions[level] = `Religious authorities grant blessings and access.`;
                        } else {
                            suggestions[level] = `The faction provides increasing benefits.`;
                        }
                    }
                }
            });

            // Display suggestions in modal
            showSuggestionsModal(factionIndex, faction.name, suggestions);
        }

        let currentSuggestions = {}; // Store suggestions globally for applyAll

        function showSuggestionsModal(factionIndex, factionName, suggestions) {
            const modal = document.getElementById("suggestionsModal");
            const content = document.getElementById("suggestionsContent");
            const title = document.getElementById("modalTitle");
            
            // Store suggestions globally
            currentSuggestions = { ...suggestions };
            modal.setAttribute('data-faction-index', factionIndex);
            
            title.textContent = `Bonus Suggestions for ${factionName}`;
            content.innerHTML = "";
            
            const sortedLevels = Object.keys(suggestions).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedLevels.forEach(level => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                const escapedText = suggestions[level].replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                div.innerHTML = `
                    <h4>Renown Level: ${level}</h4>
                    <p>${suggestions[level]}</p>
                    <button onclick="applySuggestion(${factionIndex}, ${level}, '${escapedText}')">Apply This Suggestion</button>
                `;
                content.appendChild(div);
            });

            // Add "Apply All" button
            const applyAllDiv = document.createElement("div");
            applyAllDiv.style.textAlign = "center";
            applyAllDiv.style.marginTop = "20px";
            const applyAllBtn = document.createElement("button");
            applyAllBtn.className = "success";
            applyAllBtn.textContent = "Apply All Suggestions";
            applyAllBtn.onclick = () => applyAllSuggestions(factionIndex);
            applyAllDiv.appendChild(applyAllBtn);
            content.appendChild(applyAllDiv);

            modal.style.display = "block";
        }

        function closeSuggestionsModal() {
            document.getElementById("suggestionsModal").style.display = "none";
        }

        function applySuggestion(factionIndex, level, text) {
            if (!worldData.factions[factionIndex].bonuses) {
                worldData.factions[factionIndex].bonuses = {};
            }
            // Unescape HTML entities
            const unescapedText = text.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
            worldData.factions[factionIndex].bonuses[level] = unescapedText;
            renderFactions();
            showMessage("Suggestion applied!", "success");
        }

        function applyAllSuggestions(factionIndex) {
            if (!worldData.factions[factionIndex].bonuses) {
                worldData.factions[factionIndex].bonuses = {};
            }
            Object.keys(currentSuggestions).forEach(level => {
                worldData.factions[factionIndex].bonuses[level] = currentSuggestions[level];
            });
            renderFactions();
            closeSuggestionsModal();
            showMessage("All suggestions applied!", "success");
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById("suggestionsModal");
            if (event.target === modal) {
                closeSuggestionsModal();
            }
        }

        // Initialize
        loadWorldData();
    </script>
</body>
</html>

