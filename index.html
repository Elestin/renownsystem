<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <title id="pageTitle">Faction and City Renown Tracker</title>
    <style id="dynamicStyles">
    body {
        font-family: 'IM Fell English SC', serif;
        background: linear-gradient(to bottom, #2e1a14, #4a3326);
        color: #f8e8c0;
        margin: 0;
        padding: 0;
    }
    h1 {
        text-align: center;
        color: #ffdd8b;
        text-shadow: 2px 2px 5px #522b0d;
    }
    p {
        text-align: center;
        font-size: 1.2em;
        margin-bottom: 20px;
        color: #ffefc2;
    }
    table {
        border-collapse: collapse;
        width: 95%;
        margin: 20px auto;
        background: rgba(255, 248, 228, 0.9);
        border: 2px solid #523c23;
        box-shadow: 0 0 15px #000;
    }
    th, td {
        border: 1px solid #b98d57;
        padding: 10px;
        text-align: center;
    }
    th {
        background: #7a5224;
        color: #f8e8c0;
        font-size: 1.2em;
        text-shadow: 1px 1px 2px #000;
    }
    td {
        color: #3e281a;
    }
    input {
        width: 80px;
        text-align: center;
        border: 1px solid #7a5224;
        border-radius: 5px;
        padding: 5px;
        background: #fdf8f3;
    }
    input:focus {
        outline: none;
        border-color: #d7b37c;
        background: #fff2db;
    }
    .renown-bar {
        height: 20px;
        width: 100%;
        background-color: #d7b37c;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }
    .renown-level {
        height: 100%;
        text-align: right;
        color: #fff;
        padding-right: 5px;
        box-sizing: border-box;
        font-weight: bold;
    }
    .positive {
        background: linear-gradient(to right, #2e8b57, #66cdaa);
    }
    .neutral {
        background: linear-gradient(to right, #4682b4, #87cefa);
    }
    .negative {
        background: linear-gradient(to right, #b22222, #dc143c);
    }
    #resetButton {
        background: #7a5224;
        color: #f8e8c0;
        font-size: 1.1em;
        padding: 10px 20px;
        border: 2px solid #b98d57;
        border-radius: 10px;
        box-shadow: 0 0 10px #000;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #resetButton:hover {
        background: #d7b37c;
        color: #522b0d;
        border-color: #ffd700;
        box-shadow: 0 0 15px #ffdd8b;
    }
    .tooltip {
        display: none;
        position: absolute;
        background-color: #7a5224;
        color: #f8e8c0;
        border: 1px solid #d7b37c;
        padding: 10px;
        font-size: 14px;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 0 10px #000;
    }
    .admin-link {
        text-align: center;
        margin: 20px;
    }
    .admin-link a {
        color: #ffdd8b;
        text-decoration: none;
        font-size: 1.1em;
        padding: 10px 20px;
        border: 2px solid #b98d57;
        border-radius: 10px;
        display: inline-block;
        transition: all 0.3s ease;
    }
    .admin-link a:hover {
        background: rgba(255, 221, 139, 0.2);
        box-shadow: 0 0 10px #ffdd8b;
    }
    button {
        background: #7a5224;
        color: #f8e8c0;
        font-size: 1em;
        padding: 8px 16px;
        border: 2px solid #b98d57;
        border-radius: 10px;
        box-shadow: 0 0 10px #000;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 5px;
        font-family: inherit;
    }
    button:hover {
        background: #d7b37c;
        color: #522b0d;
        border-color: #ffd700;
        box-shadow: 0 0 15px #ffdd8b;
    }
    </style>
</head>
<body>
    <div class="admin-link">
        <a href="admin.html">⚙️ Admin Panel</a>
    </div>
    <h1 id="pageHeading" style="text-align: center;">Faction and City Renown Tracker</h1>
    <p style="text-align: center;">Hover over a faction or city to see detailed bonuses/penalties. Changes are saved automatically and persist between sessions.</p>
    <div id="tooltip" class="tooltip"></div>
    <table>
        <thead>
            <tr>
                <th>Faction/City</th>
                <th>Base Renown</th>
                <th>Party Actions</th>
                <th>Cross-Faction Modifiers</th>
                <th>Total Renown</th>
                <th>Renown Level</th>
            </tr>
        </thead>
        <tbody id="renownTable">
            <!-- Rows populated by JavaScript -->
        </tbody>
    </table>
    <div style="text-align: center; margin-top: 20px;">
        <button id="resetButton" onclick="resetRenown()">Reset Renown</button>
    </div>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="exportRenownData()">Export Renown Data</button>
        <button onclick="importRenownData()">Import Renown Data</button>
        <button onclick="exportFullWorld()">Export Full World</button>
        <button onclick="importFullWorld()">Import Full World</button>
        <input type="file" id="importRenownFile" style="display: none;" onchange="handleRenownImport(event)">
        <input type="file" id="importWorldFile" style="display: none;" accept=".json" onchange="handleWorldImport(event)">
    </div>

    <script>
        let worldData = null;
        let factions = [];
        let relationshipTable = {};
        let savedData = [];

        // Load world data from localStorage
        function loadWorldData() {
            const saved = localStorage.getItem("worldData");
            if (saved) {
                try {
                    worldData = JSON.parse(saved);
                    factions = worldData.factions || [];
                    relationshipTable = worldData.relationships || {};
                    applyTheme();
                    initializeRenownData();
                } catch (e) {
                    console.error("Error loading world data:", e);
                    loadDefaultData();
                }
            } else {
                loadDefaultData();
            }
        }

        function loadDefaultData() {
            // Default data structure
            worldData = {
                worldName: "Default World",
                theme: {
                    fontFamily: "'IM Fell English SC', serif",
                    bgColor1: "#2e1a14",
                    bgColor2: "#4a3326",
                    textColor: "#f8e8c0",
                    headingColor: "#ffdd8b",
                    tableBg: "rgba(255, 248, 228, 0.9)",
                    tableBorder: "#523c23",
                    positiveColor1: "#2e8b57",
                    positiveColor2: "#66cdaa",
                    neutralColor1: "#4682b4",
                    neutralColor2: "#87cefa",
                    negativeColor1: "#b22222",
                    negativeColor2: "#dc143c"
                },
                factions: [
                    { name: "Example Faction A", bonuses: {
                        "-100": "Faction A declares you an enemy and attacks on sight.",
                        "-80": "Faction A actively hunts the party.",
                        "-60": "Faction A denies services and access.",
                        "-40": "Faction A is hostile and uncooperative.",
                        "-20": "Faction A is suspicious and wary.",
                        "0": "Neutral stance; standard behavior.",
                        "20": "Faction A provides minor assistance.",
                        "40": "Faction A offers discounts and basic services.",
                        "60": "Faction A provides significant support.",
                        "80": "Faction A grants access to exclusive resources.",
                        "100": "Faction A fully supports the party."
                    }},
                    { name: "Example Faction B", bonuses: {
                        "-100": "Faction B marks you for elimination.",
                        "-80": "Faction B actively works against you.",
                        "-60": "Faction B blocks your access to resources.",
                        "-40": "Faction B is unfriendly and obstructive.",
                        "-20": "Faction B is cautious around you.",
                        "0": "Neutral stance; no special treatment.",
                        "20": "Faction B offers basic cooperation.",
                        "40": "Faction B provides helpful services.",
                        "60": "Faction B shares valuable information.",
                        "80": "Faction B grants special privileges.",
                        "100": "Faction B becomes a strong ally."
                    }},
                    { name: "Example City", bonuses: {
                        "-100": "City bars entry to the party.",
                        "-80": "City residents are hostile.",
                        "-60": "City services are denied.",
                        "-40": "City merchants overcharge significantly.",
                        "-20": "City residents are distrustful.",
                        "0": "Neutral stance; standard city services.",
                        "20": "City provides minor discounts.",
                        "40": "City offers helpful guides and services.",
                        "60": "City grants access to exclusive areas.",
                        "80": "City provides free lodging and supplies.",
                        "100": "City honors the party as heroes."
                    }}
                ],
                relationships: {
                    "Example Faction A": {
                        friends: ["Example City"],
                        enemies: ["Example Faction B"]
                    },
                    "Example Faction B": {
                        friends: [],
                        enemies: ["Example Faction A"]
                    },
                    "Example City": {
                        friends: ["Example Faction A"],
                        enemies: ["Example Faction B"]
                    }
                }
            };
            factions = worldData.factions;
            relationshipTable = worldData.relationships;
            applyTheme();
            initializeRenownData();
        }

        function applyTheme() {
            if (!worldData || !worldData.theme) return;
            
            const theme = worldData.theme;
            const style = document.getElementById("dynamicStyles");
            
            style.textContent = `
                body {
                    font-family: ${theme.fontFamily};
                    background: linear-gradient(to bottom, ${theme.bgColor1}, ${theme.bgColor2});
                    color: ${theme.textColor};
                    margin: 0;
                    padding: 0;
                }
                h1 {
                    text-align: center;
                    color: ${theme.headingColor};
                    text-shadow: 2px 2px 5px #522b0d;
                }
                p {
                    text-align: center;
                    font-size: 1.2em;
                    margin-bottom: 20px;
                    color: ${theme.textColor};
                }
                table {
                    border-collapse: collapse;
                    width: 95%;
                    margin: 20px auto;
                    background: ${theme.tableBg};
                    border: 2px solid ${theme.tableBorder};
                    box-shadow: 0 0 15px #000;
                }
                th, td {
                    border: 1px solid #b98d57;
                    padding: 10px;
                    text-align: center;
                }
                th {
                    background: #7a5224;
                    color: ${theme.textColor};
                    font-size: 1.2em;
                    text-shadow: 1px 1px 2px #000;
                }
                td {
                    color: #3e281a;
                }
                input {
                    width: 80px;
                    text-align: center;
                    border: 1px solid #7a5224;
                    border-radius: 5px;
                    padding: 5px;
                    background: #fdf8f3;
                }
                input:focus {
                    outline: none;
                    border-color: #d7b37c;
                    background: #fff2db;
                }
                .renown-bar {
                    height: 20px;
                    width: 100%;
                    background-color: #d7b37c;
                    border-radius: 5px;
                    overflow: hidden;
                    position: relative;
                }
                .renown-level {
                    height: 100%;
                    text-align: right;
                    color: #fff;
                    padding-right: 5px;
                    box-sizing: border-box;
                    font-weight: bold;
                }
                .positive {
                    background: linear-gradient(to right, ${theme.positiveColor1}, ${theme.positiveColor2});
                }
                .neutral {
                    background: linear-gradient(to right, ${theme.neutralColor1}, ${theme.neutralColor2});
                }
                .negative {
                    background: linear-gradient(to right, ${theme.negativeColor1}, ${theme.negativeColor2});
                }
                #resetButton {
                    background: #7a5224;
                    color: ${theme.textColor};
                    font-size: 1.1em;
                    padding: 10px 20px;
                    border: 2px solid #b98d57;
                    border-radius: 10px;
                    box-shadow: 0 0 10px #000;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                #resetButton:hover {
                    background: #d7b37c;
                    color: #522b0d;
                    border-color: #ffd700;
                    box-shadow: 0 0 15px #ffdd8b;
                }
                .tooltip {
                    display: none;
                    position: absolute;
                    background-color: #7a5224;
                    color: ${theme.textColor};
                    border: 1px solid #d7b37c;
                    padding: 10px;
                    font-size: 14px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 0 10px #000;
                }
                .admin-link {
                    text-align: center;
                    margin: 20px;
                }
                .admin-link a {
                    color: ${theme.headingColor};
                    text-decoration: none;
                    font-size: 1.1em;
                    padding: 10px 20px;
                    border: 2px solid #b98d57;
                    border-radius: 10px;
                    display: inline-block;
                    transition: all 0.3s ease;
                }
                .admin-link a:hover {
                    background: rgba(255, 221, 139, 0.2);
                    box-shadow: 0 0 10px ${theme.headingColor};
                }
                button {
                    background: #7a5224;
                    color: ${theme.textColor};
                    font-size: 1em;
                    padding: 8px 16px;
                    border: 2px solid #b98d57;
                    border-radius: 10px;
                    box-shadow: 0 0 10px #000;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin: 5px;
                    font-family: ${theme.fontFamily};
                }
                button:hover {
                    background: #d7b37c;
                    color: #522b0d;
                    border-color: #ffd700;
                    box-shadow: 0 0 15px #ffdd8b;
                }
            `;
            
            if (worldData.worldName) {
                document.getElementById("pageTitle").textContent = worldData.worldName + " - Renown Tracker";
                document.getElementById("pageHeading").textContent = worldData.worldName + " - Renown Tracker";
            }
        }

        function initializeRenownData() {
            const saved = localStorage.getItem("renownData");
            if (saved) {
                try {
                    savedData = JSON.parse(saved);
                    // Filter to only include factions that exist in current world
                    savedData = savedData.filter(data => 
                        factions.some(f => f.name === data.name)
                    );
                } catch (e) {
                    console.error("Error loading renown data:", e);
                    savedData = [];
                }
            }
            
            // Initialize missing factions
            factions.forEach(faction => {
                if (!savedData.find(d => d.name === faction.name)) {
                    savedData.push({
                        name: faction.name,
                        baseRenown: 0,
                        partyActions: 0,
                        crossFactionModifiers: 0,
                        totalRenown: 0
                    });
                }
            });
            
            // Remove factions that no longer exist
            savedData = savedData.filter(data => 
                factions.some(f => f.name === data.name)
            );
            
            saveToLocalStorage();
            calculateRenown();
        }

        function resetRenown() {
            const confirmation = prompt("Type DELETE to confirm renown reset:");
            if (confirmation === "DELETE") {
                savedData.forEach(faction => {
                    faction.baseRenown = 0;
                    faction.partyActions = 0;
                    faction.crossFactionModifiers = 0;
                    faction.totalRenown = 0;
                });
                saveToLocalStorage();
                renderTable();
                alert("Renown has been reset.");
            } else {
                alert("Renown reset canceled.");
            }
        }

        function calculateRenown() {
            savedData.forEach(faction => {
                faction.totalRenown = faction.baseRenown + faction.partyActions + faction.crossFactionModifiers;
            });
            saveToLocalStorage();
            renderTable();
        }

        function saveToLocalStorage() {
            localStorage.setItem("renownData", JSON.stringify(savedData));
        }

        function renderTable() {
            const tableBody = document.getElementById("renownTable");
            tableBody.innerHTML = "";
            savedData.forEach(faction => {
                const renownClass =
                    faction.totalRenown >= 50 ? "positive" :
                    faction.totalRenown >= 0 ? "neutral" : "negative";
                const bonuses = factions.find(f => f.name === faction.name)?.bonuses || {};
                const row = `
                    <tr>
                        <td onmouseover="showTooltip('${faction.name}', ${faction.totalRenown})" onmouseout="hideTooltip()">${faction.name}</td>
                        <td><input type="number" value="${faction.baseRenown}" onchange="updateBaseRenown('${faction.name}', this.value)"></td>
                        <td><input type="number" value="${faction.partyActions}" onchange="updatePartyActions('${faction.name}', this.value)"></td>
                        <td>${faction.crossFactionModifiers.toFixed(2)}</td>
                        <td>${faction.totalRenown.toFixed(2)}</td>
                        <td>
                            <div class="renown-bar">
                                <div class="renown-level ${renownClass}" style="width: ${Math.min(Math.max((faction.totalRenown + 100) / 2, 0), 100)}%;">
                                    ${Math.round(faction.totalRenown)}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function showTooltip(name, totalRenown) {
            const tooltip = document.getElementById("tooltip");
            const faction = factions.find(f => f.name === name);
            const bonuses = faction?.bonuses || {};
            const closestLevel = Object.keys(bonuses).reduce((prev, curr) => 
                Math.abs(parseInt(curr) - totalRenown) < Math.abs(parseInt(prev) - totalRenown) ? curr : prev
            );
            tooltip.innerHTML = `<strong>${name} Bonuses:</strong><br>${bonuses[closestLevel] || "No specific bonus at this level."}`;
            tooltip.style.display = "block";
            document.addEventListener("mousemove", positionTooltip);
        }

        function hideTooltip() {
            const tooltip = document.getElementById("tooltip");
            tooltip.style.display = "none";
            document.removeEventListener("mousemove", positionTooltip);
        }

        function positionTooltip(event) {
            const tooltip = document.getElementById("tooltip");
            tooltip.style.left = event.pageX + 15 + "px";
            tooltip.style.top = event.pageY + 15 + "px";
        }

        function updateBaseRenown(name, value) {
            const faction = savedData.find(f => f.name === name);
            const oldRenown = faction.baseRenown;
            faction.baseRenown = parseInt(value) || 0;
            const delta = faction.baseRenown - oldRenown;

            adjustRelatedRenown(name, delta);
            calculateRenown();
        }

        function updatePartyActions(name, value) {
            const faction = savedData.find(f => f.name === name);
            const oldRenown = faction.partyActions;
            faction.partyActions = parseInt(value) || 0;
            const delta = faction.partyActions - oldRenown;

            adjustRelatedRenown(name, delta);
            calculateRenown();
        }

        function adjustRelatedRenown(name, delta) {
            const relationships = relationshipTable[name];
            if (!relationships) return;

            relationships.enemies?.forEach(enemyName => {
                const enemy = savedData.find(f => f.name === enemyName);
                if (enemy) {
                    enemy.crossFactionModifiers -= delta * 0.5; // Enemies lose half the delta
                }
            });

            relationships.friends?.forEach(friendName => {
                const friend = savedData.find(f => f.name === friendName);
                if (friend) {
                    friend.crossFactionModifiers += delta * 0.3; // Friends gain 30% of the delta
                }
            });
        }

        function exportRenownData() {
            const dataStr = JSON.stringify(savedData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "renown_data.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function importRenownData() {
            document.getElementById("importRenownFile").click();
        }

        function handleRenownImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    validateAndLoadRenownData(importedData);
                } catch (error) {
                    alert("Failed to import data: Invalid JSON file.");
                }
            };
            reader.readAsText(file);
            event.target.value = "";
        }

        function validateAndLoadRenownData(data) {
            if (Array.isArray(data) && data.every(item => item.name && "baseRenown" in item && "totalRenown" in item)) {
                // Only import data for factions that exist in current world
                const validData = data.filter(item => 
                    factions.some(f => f.name === item.name)
                );
                savedData.splice(0, savedData.length, ...validData);
                saveToLocalStorage();
                renderTable();
                alert("Renown data successfully imported!");
            } else {
                alert("Failed to import data: Invalid data structure.");
            }
        }

        function exportFullWorld() {
            const exportData = {
                ...worldData,
                savedRenownData: savedData
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${worldData.worldName.replace(/[^a-z0-9]/gi, '_')}_complete.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFullWorld() {
            document.getElementById("importWorldFile").click();
        }

        function handleWorldImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.factions && imported.theme && imported.relationships) {
                        worldData = imported;
                        factions = worldData.factions || [];
                        relationshipTable = worldData.relationships || {};
                        
                        // Save world data
                        localStorage.setItem("worldData", JSON.stringify(worldData));
                        
                        // Load saved renown data if present
                        if (imported.savedRenownData) {
                            savedData = imported.savedRenownData;
                            localStorage.setItem("renownData", JSON.stringify(savedData));
                        } else {
                            initializeRenownData();
                        }
                        
                        applyTheme();
                        calculateRenown();
                        alert("Full world imported successfully!");
                    } else {
                        alert("Invalid world file format.");
                    }
                } catch (error) {
                    alert("Failed to import: " + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = "";
        }

        // Initialize on page load
        loadWorldData();
    </script>
</body>
</html>
